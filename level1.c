#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include "bitplane.h"
#include "misc.h"

struct Level {
    int arch; // Archetype
    int lay_loc; // 32x32 layout
    int lay_len; // 32x32 layout
    int pal_ofs; // Palette data
    // int pal_fix; // Palette Fixes
    char *name; // Output Filename
};

struct Archetypes {
    uint8_t  bp_a; // Bitplane bank
    uint16_t bp_y; // Bitplane addr
    int raw_loc; // 8x8 layout data
    int raw_len; // 8x8 layout length
};

struct Area {
    int type; // Archetype
    int pal_ofs; // Palette data
    int pal_fix; // Palette Fixes
    uint8_t crop[8]; // Cropping Coordinates
    char *name; // Level Name
};

static inline void push_8(uint8_t stack[10], int *sc, uint8_t *value) {
    stack[*sc] = *value;
    *sc = *sc + 1;
} // push_8

static inline void pull_8(uint8_t stack[10], int *sc, uint8_t *value) {
    *sc = *sc - 1;
    *value = stack[*sc];
} // pull_8

static inline void push_16(uint8_t stack[10], int *sc, uint16_t *value) {
    stack[*sc] = *value % 256;
    *sc = *sc + 1;
    stack[*sc] = (*value - (*value % 256)) / 256;
    *sc = *sc + 1;
} // push_16

static inline void pull_16(uint8_t stack[10], int *sc, uint16_t *value) {
    *sc = *sc - 1;
    *sc = *sc - 1;
    *value = (stack[*sc+1] * 256) + stack[*sc];
} // pull_16

static inline void xba(uint8_t *a, uint8_t *b) {
    uint8_t temp = *a;
    *a = *b;
    *b = temp;
} // xba

static void dkc_tile_decomp(uint8_t *rom, uint8_t *bp_data, unsigned int *bp_len, uint8_t a, uint16_t y) {

    uint16_t c, x = 0, tF7, tFA;
    uint8_t b = 0, bank = a;
    uint8_t mem[256];
    uint8_t stack[10];
    int sc = 0; // Stack Counter
    int jmp = 0x970E;
    int run = 1;
    
    // 8-bit A
    push_8(stack, &sc, &a);
    tF7 = x;
    tFA = y;
    
    // int count = 0;
    
    while (run) {
        
        // count++;
        // printf("\n\n%04d:\n", count);
        // printf("\tj = %04X\n", jmp);
        // printf("\ta = %02X%02X\n", b, a);
        // printf("\tx = %04X\n", x);
        // printf("\ty = %04X\n", y);
        
        switch(jmp) {
            
            case 0x970E:
                a = rom[(bank*0x10000) + y + 0x80];
                if (a == 0) {
                    jmp = 0x9728;
                    break;
                }
                xba(&a, &b);
                a = rom[(bank*0x10000) + y + 0x80];
                y++;
                a &= 0xC0;
                if (!(a & 0xC0)) {
                    jmp = 0x9743;
                    break;
                }
                if (a == 0x80) {
                    jmp = 0x9754;
                    break;
                }
                if (a == 0xC0) {
                    jmp = 0x977B;
                    break;
                }
                if (a == 0x40) {
                    jmp = 0x972C;
                    break;
                }
                jmp = 0x9728;
            break;
            
            case 0x9728:
                run = 0;
            break;
            
            case 0x972C:
                xba(&a, &b);
                a &= 0x3F;
                tF7 = a;
                a = rom[(bank*0x10000) + y + 0x80];
                jmp = 0x9734;
            break;
            
            case 0x9734:
                y++;
                push_16(stack, &sc, &y);
                y = tF7;
                jmp = 0x9738;
            break;
            
            case 0x9738:
                bp_data[x] = a;
                x++;
                y--;
                if (y > 0) break;
                pull_16(stack, &sc, &y);
                jmp = 0x970E;
            break;
            
            case 0x9743:
                xba(&a, &b);
                jmp = 0x9744;
            break;
            
            case 0x9744:
                xba(&a, &b);
                a = rom[(bank*0x10000) + y + 0x80];
                bp_data[x] = a;
                x++;
                y++;
                xba(&a, &b);
                a--;
                jmp = (a > 0) ? 0x9744 : 0x970E;
            break;
            
            case 0x9754:
                xba(&a, &b);
                a &= 0x3F;
                mem[0xF9] = a;
                // 16-bit A
                a = rom[(bank*0x10000) + y + 0x80];
                y++;
                b = rom[(bank*0x10000) + y + 0x80];
                y++;
                push_16(stack, &sc, &y);
                y = (b*256)+a;
                // 8-bit A
                a = mem[0xF9];
                jmp = 0x9766;
            break;
            
            case 0x9766:
                xba(&a, &b);
                push_16(stack, &sc, &x);
                x = y;
                a = bp_data[x];
                pull_16(stack, &sc, &x);
                bp_data[x] = a;
                y++;
                x++;
                xba(&a, &b);
                a--;
                if (a > 0) break;
                pull_16(stack, &sc, &y);
                jmp = 0x970E;
            break;
            
            case 0x977B:
                a = 0;
                xba(&a, &b);
                // 16-bit A
                c = (b*256)+a;
                c &= 0x003F;
                c <<= 1;
                c += tFA;
                push_16(stack, &sc, &y);
                y = c;
                a = rom[(bank*0x10000) + y];
                b = rom[(bank*0x10000) + y + 1];
                bp_data[x] = a;
                bp_data[x+1] = b;
                x += 2;
                // 8-bit A
                pull_16(stack, &sc, &y);
                jmp = 0x970E;
            break;
            
            default:
                run = 0;
                printf("\nError\n");
                break;
        }
    
    }
    
    *bp_len = x;
    
    return;

} // dkc_tile_decomp();

void level1(unsigned char *rom, char *dir, int priority, int mode) {

    uint8_t *bp_data = calloc(0xFFFF, 1);
    unsigned int bp_len = 0;
    
    uint8_t *lay_data = malloc(0xFFFF);
    uint8_t *raw_data = malloc(0xFFFF);
    int raw_counter = 0;
    int lay_counter = 0;

    uint8_t *bitplane = malloc(512 * 2000 * 4);
    
    const struct Level levels[] = {
        { 0, 0x190000, 0xA3C0, 0x39A1DC, "Jungles.png"},
        { 1, 0x1A0000, 0xBF00, 0x39A01C, "Caves.png"},
        { 2, 0x0B0000, 0xE040, 0x39A2DC, "Walkway.png"},
        { 3, 0x1B05CC, 0x9B00, 0x39A3DC, "Mines.png"},
        { 4, 0x220000, 0x6200, 0x39B0A3, "Factory.png"},
        { 5, 0x290000, 0xC380, 0x399C1C, "Underwater.png"},
        { 6, 0x2C1728, 0x6700, 0x39B3A3, "Temple.png"},
        { 7, 0x203636, 0x74A0, 0x399B1C, "Snow.png"},
        { 8, 0x2101E5, 0x3A00, 0x39C723, "Ice Caves.png"},
        { 9, 0x260D88, 0x9400, 0x399A14, "Mine Cart.png"},
        {10, 0x030000, 0x5200, 0x39B2A3, "Treetown.png"},
        {11, 0x036200, 0x5B00, 0x39C623, "Forest.png"},
        {12, 0x230000, 0x200, 0x39D363, "Gang-Plank Galleon.png"},
        {13, 0x03EDA0, 0x200, 0x39CE63, "Bosses.png"}
    };
    
    const struct Area areas[] = {
        
        { 0, 0x39A1DC, 62, {0x00, 0x15, 0x00, 0x17, 0x00, 0x00, 0x00, 0x01}, "Jungles BG.png"},
        { 0, 0x39A1DC, 0, {0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00, 0x02}, "Jungle Hijinxs (Day).png"},
        { 0, 0x39A1DC, 58, {0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00, 0x02}, "Jungle Hijinxs (Night).png"},
        { 0, 0x39A1DC, 0, {0x60, 0x5D, 0x60, 0x5E, 0x00, 0x01, 0x00, 0x02}, "Jungle Hijinxs B2.png"},
        { 0, 0x39A1DC, 0, {0x00, 0x17, 0x80, 0x37, 0x00, 0x00, 0x00, 0x02}, "Ropey Rampage (Day).png"},
        { 0, 0x39A1DC, 58, {0x00, 0x17, 0x80, 0x37, 0x00, 0x00, 0x00, 0x02}, "Ropey Rampage (Night).png"},
        { 0, 0x39A1DC, 58, {0x60, 0x5F, 0x60, 0x63, 0x00, 0x01, 0x00, 0x02}, "Ropey Rampage B1.png"},
        { 0, 0x39A1DC, 58, {0x60, 0x5D, 0x60, 0x5E, 0x00, 0x00, 0x00, 0x01}, "Ropey Rampage B2.png"},
        { 0, 0x39A1DC, 57, {0x80, 0x37, 0x60, 0x5D, 0x00, 0x00, 0x00, 0x02}, "Orang-utan Gang.png"},
        { 0, 0x39A1DC, 57, {0x60, 0x5D, 0x60, 0x5E, 0x00, 0x01, 0x00, 0x02}, "Orang-utan Gang B1.png"},
        { 0, 0x39A1DC, 57, {0x60, 0x61, 0x60, 0x62, 0x00, 0x00, 0x00, 0x01}, "Orang-utan Gang B2.png"},
        { 0, 0x39A1DC, 57, {0x60, 0x60, 0x60, 0x61, 0x00, 0x00, 0x00, 0x01}, "Orang-utan Gang B3.png"},
        { 0, 0x39A1DC, 57, {0x60, 0x5F, 0x60, 0x60, 0x00, 0x00, 0x00, 0x01}, "Orang-utan Gang B4.png"},
        { 0, 0x39A1DC, 57, {0x60, 0x5F, 0x60, 0x63, 0x00, 0x01, 0x00, 0x02}, "Orang-utan Gang B5.png"},
        { 0, 0x39A1DC, 0, {0x60, 0x63, 0x40, 0x8D, 0x00, 0x00, 0x00, 0x02}, "Barrel Cannon Canyon.png"},
        { 0, 0x39A1DC, 0, {0x60, 0x8F, 0x60, 0x90, 0x00, 0x00, 0x00, 0x02}, "Barrel Cannon Canyon B2.png"},
        { 0, 0x39A1DC, 0, {0x60, 0x5E, 0x60, 0x5F, 0x00, 0x00, 0x00, 0x02}, "Jungle 3.png"},
        { 0, 0x39A1DC, 0, {0x60, 0x62, 0x60, 0x63, 0x00, 0x00, 0x00, 0x01}, "Jungle 7.png"},
        { 0, 0x39A1DC, 0, {0x60, 0x8D, 0x60, 0x8F, 0x00, 0x00, 0x00, 0x02}, "Jungle A.png"},
        { 0, 0x39A1DC, 0, {0x60, 0x90, 0x60, 0x92, 0x00, 0x00, 0x00, 0x02}, "Jungle C.png"},
        { 0, 0x39A1DC, 0, {0x60, 0x92, 0x60, 0x94, 0x00, 0x00, 0x00, 0x01}, "Jungle D.png"},
        { 0, 0x39A1DC, 0, {0x60, 0x94, 0xC0, 0xA3, 0x00, 0x00, 0x00, 0x02}, "Expresso Room.png"}, // 22
        
        { 1, 0x39A01C, 0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01}, "Caves BG-1.png"},
        { 1, 0x39AF65, 0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01}, "Caves BG-2.png"},
        { 1, 0x39A01C, 0, {0x00, 0x01, 0x00, 0x1B, 0x00, 0x00, 0x00, 0x02}, "Reptile Rumble.png"},
        { 1, 0x39AF65, 59, {0x00, 0x69, 0x00, 0x6C, 0x00, 0x00, 0x00, 0x01}, "Reptile Rumble B1.png"},
        { 1, 0x39AF65, 0, {0x00, 0xB3, 0x00, 0xB5, 0x00, 0x00, 0x00, 0x02}, "Reptile Rumble B2.png"},
        { 1, 0x39AF65, 61, {0x00, 0x6D, 0x00, 0x6F, 0x00, 0x00, 0x00, 0x02}, "Reptile Rumble B3.png"},
        { 1, 0x39AD65, 0, {0x00, 0x1B, 0x80, 0x3F, 0x00, 0x00, 0x00, 0x02}, "Bouncy Bonanza.png"},
        { 1, 0x39AF65, 60, {0x00, 0x6C, 0x00, 0x6D, 0x00, 0x00, 0x00, 0x01}, "Bouncy Bonanza B1&2.png"},
        { 1, 0x39AE65, 0, {0x80, 0x40, 0x00, 0x69, 0x00, 0x00, 0x00, 0x02}, "Manic Mincers.png"},
        { 1, 0x39A01C, 0, {0x00, 0xAF, 0x00, 0xB1, 0x00, 0x01, 0x00, 0x02}, "Manic Mincers B2.png"},
        { 1, 0x39A01C, 0, {0x00, 0x86, 0x00, 0xAF, 0x00, 0x00, 0x00, 0x02}, "Elevator Antics.png"},
        { 1, 0x39AF65, 0, {0x80, 0x3F, 0x80, 0x40, 0x00, 0x00, 0x00, 0x02}, "Elevator Antics B2.png"}, // Bouncy Bonanza B3 ?
        { 1, 0x39A01C, 0, {0x00, 0x71, 0x00, 0x86, 0x00, 0x00, 0x00, 0x02}, "Torchlight Trouble.png"},
        { 1, 0x39A01C, 0, {0x00, 0x6C, 0x00, 0x6D, 0x00, 0x00, 0x00, 0x01}, "TorchlightT B1&2 & ElevatorA B1 & ManicM B1&2.png"},
        { 1, 0x39AF65, 0, {0x00, 0x69, 0x00, 0x6D, 0x00, 0x01, 0x00, 0x02}, "Jungle Hijinxs B1.png"},
        { 1, 0x39AF65, 0, {0x00, 0xAF, 0x00, 0xB3, 0x00, 0x00, 0x00, 0x01}, "Barrel Cannon Canyon B1.png"},
        { 1, 0x39A01C, 0, {0x00, 0xAF, 0x00, 0xB3, 0x00, 0x00, 0x00, 0x01}, "BarrelCC B1 & TorchlightT B2 & MineCM B1.png"},
        { 1, 0x39A01C, 0, {0x00, 0xB5, 0x00, 0xBF, 0x00, 0x00, 0x00, 0x02}, "Winky Token Room.png"},
        { 1, 0x39AF65, 0, {0x00, 0xB0, 0x00, 0xB1, 0x00, 0x01, 0x00, 0x02}, "Banana Hoard.png"},
        { 1, 0x39A01C, 0, {0x00, 0x6F, 0x00, 0x71, 0x00, 0x00, 0x00, 0x02}, "Caves 9.png"},
        { 1, 0x39A01C, 0, {0x80, 0x4A, 0x80, 0x4C, 0x00, 0x01, 0x00, 0x02}, "Unused Caves Bonus.png"}, // 21
        
        { 2, 0x39A2DC, 0, {0x80, 0xCA, 0x40, 0xE0, 0x00, 0x00, 0x00, 0x02}, "Winky's Walkway.png"},
        { 2, 0x39A2DC, 0, {0x80, 0xC9, 0x80, 0xCA, 0x00, 0x01, 0x00, 0x02}, "WinkysW B1 & TrickTT B2&3 & MineCM B2 & TankedUT B1 & PlatformP B1&2.png"},
        { 2, 0x39A2DC, 0, {0x00, 0x00, 0x00, 0x3A, 0x00, 0x00, 0x00, 0x02}, "Mine Cart Madness.png"},
        { 2, 0x39A2DC, 0, {0x80, 0x6B, 0x80, 0x99, 0x00, 0x00, 0x00, 0x02}, "Trick Track Trek.png"},
        { 2, 0x39A2DC, 0, {0x80, 0xCA, 0x80, 0xCC, 0x00, 0x00, 0x00, 0x02}, "Trick Track Trek B1.png"},
        { 2, 0x39A2DC, 0, {0x80, 0x99, 0x80, 0xC9, 0x00, 0x00, 0x00, 0x02}, "Tanked Up Trouble.png"},
        { 2, 0x39A2DC, 0, {0x00, 0x3B, 0x80, 0x6B, 0x00, 0x00, 0x00, 0x02}, "Platform Perils.png"},
        { 2, 0x39A2DC, 0, {0x00, 0x3A, 0x00, 0x3B, 0x00, 0x00, 0x00, 0x01}, "Walkway 1.png"},
        { 2, 0x39A2DC, 0, {0x80, 0xC9, 0x80, 0xCA, 0x00, 0x00, 0x00, 0x01}, "Walkway 2.png"}, // 9
        
        { 3, 0x39A3DC, 0, {0x00, 0x01, 0x00, 0x03, 0x00, 0x00, 0x00, 0x02}, "Stop & Go Station B1.png"},
        { 3, 0x39A3DC, 0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02}, "Stop & Go Station B2.png"},
        { 3, 0x39A3DC, 0, {0x80, 0x34, 0x00, 0x5B, 0x00, 0x00, 0x00, 0x02}, "Stop & Go Station.png"},
        { 3, 0x39A3DC, 0, {0x00, 0x03, 0x80, 0x34, 0x00, 0x00, 0x00, 0x02}, "Misty Mine.png"},
        { 3, 0x39A3DC, 0, {0x00, 0x5B, 0x00, 0x62, 0x00, 0x01, 0x00, 0x02}, "Misty Mine B1.png"},
        { 3, 0x39A3DC, 0, {0x00, 0x5B, 0x00, 0x5C, 0x00, 0x00, 0x00, 0x01}, "Misty Mine B2.png"},
        { 3, 0x39A3DC, 59, {0x00, 0x62, 0x00, 0x91, 0x00, 0x00, 0x00, 0x02}, "Loopy Lights.png"},
        { 3, 0x39A3DC, 0, {0x00, 0x5E, 0x00, 0x62, 0x00, 0x00, 0x00, 0x01}, "Loopy Lights B1.png"},
        { 3, 0x39A3DC, 0, {0x00, 0x91, 0x00, 0x97, 0x00, 0x00, 0x00, 0x02}, "Loopy Lights B2.png"},
        { 3, 0x39A3DC, 0, {0x00, 0x5C, 0x00, 0x5E, 0x00, 0x00, 0x00, 0x01}, "Mines 6.png"},
        { 3, 0x39A3DC, 0, {0x00, 0x97, 0x00, 0x99, 0x00, 0x00, 0x00, 0x02}, "Mines 11.png"},
        { 3, 0x39A3DC, 0, {0x00, 0x99, 0x00, 0x9B, 0x00, 0x00, 0x00, 0x01}, "Mines 12.png"}, // 12
        
        { 4, 0x39B0A3, 0, {0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02}, "Oil Drum Alley FG.png"},
        { 4, 0x39B0A3, 63, {0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02}, "Blackout Basement FG.png"},
        { 4, 0x39B0A3, 0, {0x00, 0x02, 0x60, 0x2F, 0x00, 0x00, 0x00, 0x02}, "Oil Drum Alley.png"},
        { 4, 0x39B0A3, 0, {0x00, 0x5D, 0x00, 0x5E, 0x00, 0x00, 0x00, 0x02}, "Oil Drum Alley B1.png"},
        { 4, 0x39B0A3, 0, {0x00, 0x59, 0x00, 0x5A, 0x00, 0x01, 0x00, 0x02}, "Oil Drum Alley B2&3.png"},
        { 4, 0x39B0A3, 0, {0x00, 0x59, 0x00, 0x5D, 0x00, 0x00, 0x00, 0x01}, "Oil Drum Alley B4.png"},
        { 4, 0x39B0A3, 63, {0x60, 0x2F, 0x60, 0x58, 0x00, 0x00, 0x00, 0x02}, "Blackout Basement.png"},
        { 4, 0x39B0A3, 63, {0x00, 0x5E, 0x00, 0x60, 0x00, 0x00, 0x00, 0x02}, "Blackout Basement B1.png"},
        { 4, 0x39B0A3, 63, {0x00, 0x59, 0x00, 0x5A, 0x00, 0x01, 0x00, 0x02}, "Blackout Basement B2.png"},
        { 4, 0x39B0A3, 0, {0x00, 0x5A, 0x00, 0x5C, 0x00, 0x01, 0x00, 0x02}, "Factory 4.png"},
        { 4, 0x39B0A3, 0, {0x00, 0x5C, 0x00, 0x5D, 0x00, 0x01, 0x00, 0x02}, "Factory 5.png"},
        { 4, 0x39B0A3, 0, {0x00, 0x60, 0x00, 0x62, 0x00, 0x00, 0x00, 0x02}, "Factory 9.png"}, // 12
        
        { 5, 0x399C1C, 0, {0x00, 0x00, 0x00, 0x08, 0x00, 0x23, 0x80, 0x2A}, "Coral Capers.png"},
        { 5, 0x399C1C, 0, {0x00, 0x00, 0x00, 0x08, 0x80, 0x2A, 0xE0, 0x30}, "Clam City.png"},
        { 5, 0x399D1C, 0, {0x00, 0x00, 0x00, 0x08, 0x20, 0x0C, 0x40, 0x1D}, "Croctopus Chase.png"},
        { 5, 0x399F1C, 0, {0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x20, 0x0C}, "Poison Pond.png"},
        { 5, 0x399E1C, 0, {0x00, 0x00, 0x80, 0x05, 0x40, 0x1D, 0x00, 0x23}, "Enguarde Token Room.png"}, // 5
        
        { 6, 0x39B3A3, 0, {0x00, 0x08, 0x00, 0x34, 0x00, 0x00, 0x00, 0x02}, "Millstone Mayhem.png"},
        { 6, 0x39B3A3, 0, {0x00, 0x66, 0x00, 0x67, 0x00, 0x00, 0x00, 0x02}, "Millstone Mayhem B1.png"},
        { 6, 0x39B3A3, 0, {0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01}, "Temple Tempest B1.png"},
        { 6, 0x39B3A3, 0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x02}, "Millstone Mayhem B2&3 & Temple Tempest B1.png"},
        { 6, 0x39B3A3, 0, {0x00, 0x01, 0x00, 0x03, 0x00, 0x01, 0x00, 0x02}, "Temple 3.png"},
        { 6, 0x39B3A3, 0, {0x00, 0x04, 0x00, 0x06, 0x00, 0x00, 0x00, 0x02}, "Temple 4.png"},
        { 6, 0x39B3A3, 0, {0x00, 0x06, 0x00, 0x08, 0x00, 0x00, 0x00, 0x02}, "Temple 5.png"},
        { 6, 0x39B3A3, 0, {0x00, 0x34, 0x00, 0x66, 0x00, 0x00, 0x00, 0x02}, "Temple 7.png"}, // 8
        
        { 7, 0x399B1C, 0, {0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01}, "Snow BG.png"},
        { 7, 0x399B1C, 0, {0x00, 0x02, 0xE0, 0x38, 0x00, 0x00, 0x00, 0x02}, "Snow Barrel Blast.png"},
        { 7, 0x399B1C, 0, {0x00, 0x3A, 0x00, 0x3B, 0x00, 0x01, 0x00, 0x02}, "Snow Barrel Blast B1 & Ice Age Alley B2.png"},
        { 7, 0x399B1C, 0, {0x00, 0x39, 0x00, 0x3A, 0x00, 0x00, 0x00, 0x02}, "Snow Barrel Blast B2.png"},
        { 7, 0x399B1C, 0, {0x00, 0x3A, 0x00, 0x3E, 0x00, 0x00, 0x00, 0x01}, "Snow Barrel Blast B3.png"},
        { 7, 0x399B1C, 0, {0x00, 0x42, 0xA0, 0x6B, 0x00, 0x00, 0x00, 0x02}, "Ice Age Alley.png"},
        { 7, 0x399B1C, 0, {0x00, 0x40, 0x00, 0x42, 0x00, 0x00, 0x00, 0x02}, "Ice Age Alley B1.png"},
        { 7, 0x399B1C, 0, {0x00, 0x3B, 0x00, 0x3D, 0x00, 0x01, 0x00, 0x02}, "Snow 3.png"},
        { 7, 0x399B1C, 0, {0x00, 0x3E, 0x00, 0x40, 0x00, 0x00, 0x00, 0x02}, "Snow 5.png"},
        { 7, 0x399B1C, 0, {0xA0, 0x6B, 0xA0, 0x74, 0x00, 0x00, 0x00, 0x02}, "Rambi Token Room.png"}, // 10
        
        { 8, 0x39C723, 0, {0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01}, "Ice Cave BG.png"},
        { 8, 0x39C723, 0, {0x00, 0x00, 0x00, 0x08, 0x00, 0x01, 0x80, 0x0C}, "Slipslide Ride.png"},
        { 8, 0x39C723, 0, {0x00, 0x06, 0x00, 0x07, 0x00, 0x01, 0x00, 0x02}, "Slipslide Ride B1&2.png"},
        { 8, 0x39C723, 0, {0x00, 0x04, 0x00, 0x06, 0x80, 0x0C, 0x80, 0x0E}, "Slipslide Ride B3.png"},
        { 8, 0x39C723, 0, {0x00, 0x02, 0x00, 0x06, 0x00, 0x00, 0x00, 0x01}, "Ice Cave 1.png"},
        { 8, 0x39C723, 0, {0x00, 0x06, 0x00, 0x08, 0x00, 0x00, 0x00, 0x01}, "Ice Cave 2.png"},
        { 8, 0x39C723, 0, {0x00, 0x07, 0x00, 0x08, 0x00, 0x01, 0x00, 0x03}, "Ice Cave 4.png"},
        { 8, 0x39C723, 0, {0x00, 0x00, 0x00, 0x02, 0x80, 0x0C, 0x80, 0x0E}, "Ice Cave 5.png"},
        { 8, 0x39C723, 0, {0x00, 0x02, 0x00, 0x04, 0x80, 0x0C, 0x80, 0x0E}, "Ice Cave 6.png"}, // 9
        
        { 9, 0x399A14, 0, {0x00, 0x00, 0x00, 0x49, 0x00, 0x00, 0x00, 0x02}, "Mine Cart Carnage.png"},
        { 9, 0x399A14, 0, {0x00, 0x4B, 0x00, 0x94, 0x00, 0x00, 0x00, 0x02}, "Mine Cart Carnage BG.png"}, // 2
        
        {10, 0x39B2A3, 0, {0x00, 0x00, 0x00, 0x29, 0x00, 0x00, 0x00, 0x02}, "Tree Top Town.png"},
        {10, 0x39B2A3, 0, {0x00, 0x29, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x02}, "Tree Top Town B2.png"},
        {10, 0x39B2A3, 0, {0x00, 0x2A, 0x00, 0x2B, 0x00, 0x01, 0x00, 0x02}, "Tree Top Town B1 & Rope Bridge Rumble B2.png"},
        {10, 0x39B1A3, 0, {0x00, 0x2B, 0x00, 0x4E, 0x00, 0x00, 0x00, 0x02}, "Rope Bridge Rumble.png"},
        {10, 0x39B2A3, 0, {0x00, 0x4E, 0x00, 0x52, 0x00, 0x00, 0x00, 0x01}, "Rope Bridge Rumble B1.png"},
        {10, 0x39B2A3, 0, {0x00, 0x4E, 0x00, 0x50, 0x00, 0x01, 0x00, 0x02}, "Treetown 6.png"}, // 6
        
        {11, 0x39C623, 0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0xC0, 0x00}, "Forest BG.png"},
        {11, 0x39C623, 0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x02}, "Forest FG.png"},
        {11, 0x39C623, 0, {0x00, 0x02, 0x00, 0x2C, 0x00, 0x00, 0x00, 0x02}, "Vulture Culture.png"},
        {11, 0x39C623, 0, {0x00, 0x2C, 0x00, 0x2D, 0x00, 0x00, 0x00, 0x01}, "Vulture Culture B1&2 & Forest Frenzy B1.png"},
        {11, 0x39C623, 0, {0x00, 0x2C, 0x00, 0x30, 0x00, 0x01, 0x00, 0x02}, "Vulture Culture B3.png"},
        {11, 0x39C623, 0, {0x00, 0x30, 0x00, 0x59, 0x00, 0x00, 0x00, 0x02}, "Forest Frenzy.png"},
        {11, 0x39C623, 0, {0x00, 0x59, 0x00, 0x5B, 0x00, 0x00, 0x00, 0x02}, "Forest Frenzy B2.png"},
        {11, 0x39C623, 0, {0x00, 0x2D, 0x00, 0x2F, 0x00, 0x00, 0x00, 0x01}, "Forest 3.png"}, // 8
        
        {12, 0x39D363, 0, {0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01}, "Gang-Plank Galleon.png"},
        {12, 0x39D363, 0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x90, 0x01}, "Gang-Plank Galleon BG.png"},
        {13, 0x39CE63, 0, {0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01}, "Boss (Large).png"},
        {13, 0x39CE63, 0, {0x00, 0x01, 0x00, 0x02, 0x00, 0x01, 0xE0, 0x01}, "Boss (Small).png"},
        {13, 0x39CE63, 0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x80, 0x01}, "Boss BG.png"},
        {13, 0x39CE63, 0, {0x00, 0x00, 0x00, 0x01, 0x80, 0x01, 0xE0, 0x01}, "Boss FG.png"} // 6
        
    }; // 130
    
    const struct Archetypes archetype[] = {
        {0x15, 0x8FC0, 0x19A3C0, 0x4940}, // Jungle
        {0x1C, 0x0000, 0x1ABF00, 0x3680}, // Caves
        {0x24, 0x17F0, 0x0BE040, 0x1FC0}, // Walkway
        {0x25, 0x0000, 0x1BA0CC, 0x2B80}, // Mines
        {0x2B, 0x0000, 0x226200, 0x1AA0}, // Factory
        {0x3A, 0x842F, 0x100000, 0x4760}, // Underwater (width = 64, vert = 1)
        {0x27, 0x3BDE, 0x2C7E28, 0x2460}, // Temple
        {0x3A, 0x219E, 0x20AAD6, 0x3040}, // Snow
        {0x18, 0x0000, 0x213BE5, 0x3120}, // Ice Caves (width = 64, vert = 1)
        {0x1D, 0x9CCE, 0x26A188, 0x1CC0}, // Mine Cart
        {0x31, 0x0000, 0x035200, 0x1000}, // Treetown
        {0x23, 0x1180, 0x03BD00, 0x30A0}, // Forest
        {0x0F, 0x0000, 0x230200, 0x0F80}, // Gang-Plank Galleon
        {0x08, 0x8864, 0x03EFA0, 0x0F40} // Bosses
    };
    
    
    int i, vert, layout_size, arch, current = 255;
    uint8_t *coords = malloc(10);
    coords[0] = 0xFF;
    coords[1] = 0xFF;
    
    int limit = (mode == 2) ? 14 : 130; // Layouts vs. Levels
    
    for (i = 0; i < limit; i++) {
    
        arch = (mode == 2) ? i : levels[areas[i].type].arch;
        
        if (arch == 12) {
            bp_len = 0x8000;
            memcpy(bp_data, &rom[0x0F0000], bp_len);
        } // Gang-Plank Galleon
        else {
            if (current != arch) dkc_tile_decomp(rom, bp_data, &bp_len, archetype[arch].bp_a, archetype[arch].bp_y);
        }
        
        if (arch == 6 && arch != current) {
            memmove(&bp_data[0x22A0], bp_data, bp_len);
            memcpy(&bp_data[0x22C0], &rom[0x1300C0], 0xC0);
        }
        // dump_bitplane(&bp_data, bp_len, 4, 16, dir, "Bitplane.png");
        
        if (arch == 5 || arch == 8) {
            vert = 1;
            layout_size = 64;
        }
        else {
            vert = 0;
            layout_size = 16;
        }
        
        memcpy(&coords[2], &areas[i].crop, 8);
        
        if (mode == 2) {
            memcpy(raw_data, &rom[archetype[arch].raw_loc], arch[archetype].raw_len);
            memcpy(lay_data, &rom[levels[i].lay_loc], levels[i].lay_len);
            raw_counter = archetype[arch].raw_len;
            lay_counter = levels[i].lay_len;
        } // Layout
        else if (current != arch) {
            memcpy(raw_data, &rom[archetype[arch].raw_loc], archetype[arch].raw_len);
            memcpy(lay_data, &rom[levels[arch].lay_loc], levels[arch].lay_len);
            raw_counter = archetype[arch].raw_len;
            lay_counter = levels[arch].lay_len;
        } // Levels
        
        if (mode == 2) {
            decode_bitplane(rom, bp_data, raw_data, bitplane, levels[i].pal_ofs, raw_counter, bp_len, 1, 0, priority);
            assemble_level(bitplane, rom, lay_data, lay_counter, 0, vert, layout_size, 0, dir, levels[i].name);
        }
        else {
            decode_bitplane(rom, bp_data, raw_data, bitplane, areas[i].pal_ofs, raw_counter, bp_len, 1, areas[i].pal_fix, priority);
            // assemble_bitplane(&bitplane, 512, raw_counter, dir, "Tiles.png");
            assemble_level(bitplane, coords, lay_data, lay_counter, 1, vert, layout_size, 0, dir, areas[i].name);
        }
        
        current = arch;
    }
    
    free(bp_data);
    free(raw_data);
    free(lay_data);
    free(bitplane);
    free(coords);
    
    return;

} // main()
