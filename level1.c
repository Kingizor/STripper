#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <dkcomp.h>
#include "bitplane.h"
#include "misc.h"

struct DKC_LEVEL {
    int arch; // Archetype
    int lay_loc; // 32x32 layout
    int lay_len; // 32x32 layout
    int pal_ofs; // Palette data
    // int pal_fix; // Palette Fixes
    char *name; // Output Filename
};
static const struct DKC_LEVEL levels[] = {
    { 0, 0x190000, 0xA3C0, 0x39A1DC, "Jungles"},
    { 1, 0x1A0000, 0xBF00, 0x39A01C, "Caves"  },
    { 2, 0x0B0000, 0xE040, 0x39A2DC, "Walkway"},
    { 3, 0x1B05CC, 0x9B00, 0x39A3DC, "Mines"  },
    { 4, 0x220000, 0x6200, 0x39B0A3, "Factory"},
    { 5, 0x290000, 0xC380, 0x399C1C, "Underwater"},
    { 6, 0x2C1728, 0x6700, 0x39B3A3, "Temple" },
    { 7, 0x203636, 0x74A0, 0x399B1C, "Snow"   },
    { 8, 0x2101E5, 0x3A00, 0x39C723, "Ice Caves"},
    { 9, 0x260D88, 0x9400, 0x399A14, "Mine Cart"},
    {10, 0x030000, 0x5200, 0x39B2A3, "Treetown" },
    {11, 0x036200, 0x5B00, 0x39C623, "Forest"   },
    {12, 0x230000,  0x200, 0x39D363, "Gang-Plank Galleon"},
    {13, 0x03EDA0,  0x200, 0x39CE63, "Bosses"   }
};

struct DKC_ARCH {
    unsigned bp_loc; // Bitplane addr
    int raw_loc; // 8x8 layout data
    int raw_len; // 8x8 layout length
};
static const struct DKC_ARCH archetype[] = {
    {0x158FC0, 0x19A3C0, 0x4940}, // Jungle
    {0x1C0000, 0x1ABF00, 0x3680}, // Caves
    {0x2417F0, 0x0BE040, 0x1FC0}, // Walkway
    {0x250000, 0x1BA0CC, 0x2B80}, // Mines
    {0x2B0000, 0x226200, 0x1AA0}, // Factory
    {0x3A842F, 0x100000, 0x4760}, // Underwater (width = 64, vert = 1)
    {0x273BDE, 0x2C7E28, 0x2460}, // Temple
    {0x3A219E, 0x20AAD6, 0x3040}, // Snow
    {0x180000, 0x213BE5, 0x3120}, // Ice Caves (width = 64, vert = 1)
    {0x1D9CCE, 0x26A188, 0x1CC0}, // Mine Cart
    {0x310000, 0x035200, 0x1000}, // Treetown
    {0x231180, 0x03BD00, 0x30A0}, // Forest
    {0x0F0000, 0x230200, 0x0F80}, // Gang-Plank Galleon
    {0x088864, 0x03EFA0, 0x0F40}  // Bosses
};

struct DKC_AREA {
    int type; // Archetype
    int pal_ofs; // Palette data
    int pal_fix; // Palette Fixes
    unsigned char crop[8]; // Cropping Coordinates
    char *name; // Level Name
};
static const struct DKC_AREA areas[] = {
    { 0, 0x39A1DC, 62, {0x00, 0x15, 0x00, 0x17, 0x00, 0x00, 0x00, 0x01}, "Jungles BG"},
    { 0, 0x39A1DC,  0, {0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00, 0x02}, "Jungle Hijinxs (Day)"},
    { 0, 0x39A1DC, 58, {0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00, 0x02}, "Jungle Hijinxs (Night)"},
    { 0, 0x39A1DC,  0, {0x60, 0x5D, 0x60, 0x5E, 0x00, 0x01, 0x00, 0x02}, "Jungle Hijinxs B2"},
    { 0, 0x39A1DC,  0, {0x00, 0x17, 0x80, 0x37, 0x00, 0x00, 0x00, 0x02}, "Ropey Rampage (Day)"},
    { 0, 0x39A1DC, 58, {0x00, 0x17, 0x80, 0x37, 0x00, 0x00, 0x00, 0x02}, "Ropey Rampage (Night)"},
    { 0, 0x39A1DC, 58, {0x60, 0x5F, 0x60, 0x63, 0x00, 0x01, 0x00, 0x02}, "Ropey Rampage B1"},
    { 0, 0x39A1DC, 58, {0x60, 0x5D, 0x60, 0x5E, 0x00, 0x00, 0x00, 0x01}, "Ropey Rampage B2"},
    { 0, 0x39A1DC, 57, {0x80, 0x37, 0x60, 0x5D, 0x00, 0x00, 0x00, 0x02}, "Orang-utan Gang"},
    { 0, 0x39A1DC, 57, {0x60, 0x5D, 0x60, 0x5E, 0x00, 0x01, 0x00, 0x02}, "Orang-utan Gang B1"},
    { 0, 0x39A1DC, 57, {0x60, 0x61, 0x60, 0x62, 0x00, 0x00, 0x00, 0x01}, "Orang-utan Gang B2"},
    { 0, 0x39A1DC, 57, {0x60, 0x60, 0x60, 0x61, 0x00, 0x00, 0x00, 0x01}, "Orang-utan Gang B3"},
    { 0, 0x39A1DC, 57, {0x60, 0x5F, 0x60, 0x60, 0x00, 0x00, 0x00, 0x01}, "Orang-utan Gang B4"},
    { 0, 0x39A1DC, 57, {0x60, 0x5F, 0x60, 0x63, 0x00, 0x01, 0x00, 0x02}, "Orang-utan Gang B5"},
    { 0, 0x39A1DC,  0, {0x60, 0x63, 0x40, 0x8D, 0x00, 0x00, 0x00, 0x02}, "Barrel Cannon Canyon"},
    { 0, 0x39A1DC,  0, {0x60, 0x8F, 0x60, 0x90, 0x00, 0x00, 0x00, 0x02}, "Barrel Cannon Canyon B2"},
    { 0, 0x39A1DC,  0, {0x60, 0x5E, 0x60, 0x5F, 0x00, 0x00, 0x00, 0x02}, "Jungle 3"},
    { 0, 0x39A1DC,  0, {0x60, 0x62, 0x60, 0x63, 0x00, 0x00, 0x00, 0x01}, "Jungle 7"},
    { 0, 0x39A1DC,  0, {0x60, 0x8D, 0x60, 0x8F, 0x00, 0x00, 0x00, 0x02}, "Jungle A"},
    { 0, 0x39A1DC,  0, {0x60, 0x90, 0x60, 0x92, 0x00, 0x00, 0x00, 0x02}, "Jungle C"},
    { 0, 0x39A1DC,  0, {0x60, 0x92, 0x60, 0x94, 0x00, 0x00, 0x00, 0x01}, "Jungle D"},
    { 0, 0x39A1DC,  0, {0x60, 0x94, 0xC0, 0xA3, 0x00, 0x00, 0x00, 0x02}, "Expresso Room"}, // 22

    { 1, 0x39A01C,  0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01}, "Caves BG-1"},
    { 1, 0x39AF65,  0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01}, "Caves BG-2"},
    { 1, 0x39A01C,  0, {0x00, 0x01, 0x00, 0x1B, 0x00, 0x00, 0x00, 0x02}, "Reptile Rumble"},
    { 1, 0x39AF65, 59, {0x00, 0x69, 0x00, 0x6C, 0x00, 0x00, 0x00, 0x01}, "Reptile Rumble B1"},
    { 1, 0x39AF65,  0, {0x00, 0xB3, 0x00, 0xB5, 0x00, 0x00, 0x00, 0x02}, "Reptile Rumble B2"},
    { 1, 0x39AF65, 61, {0x00, 0x6D, 0x00, 0x6F, 0x00, 0x00, 0x00, 0x02}, "Reptile Rumble B3"},
    { 1, 0x39AD65,  0, {0x00, 0x1B, 0x80, 0x3F, 0x00, 0x00, 0x00, 0x02}, "Bouncy Bonanza"},
    { 1, 0x39AF65, 60, {0x00, 0x6C, 0x00, 0x6D, 0x00, 0x00, 0x00, 0x01}, "Bouncy Bonanza B1&2"},
    { 1, 0x39AE65,  0, {0x80, 0x40, 0x00, 0x69, 0x00, 0x00, 0x00, 0x02}, "Manic Mincers"},
    { 1, 0x39A01C,  0, {0x00, 0xAF, 0x00, 0xB1, 0x00, 0x01, 0x00, 0x02}, "Manic Mincers B2"},
    { 1, 0x39A01C,  0, {0x00, 0x86, 0x00, 0xAF, 0x00, 0x00, 0x00, 0x02}, "Elevator Antics"},
    { 1, 0x39AF65,  0, {0x80, 0x3F, 0x80, 0x40, 0x00, 0x00, 0x00, 0x02}, "Elevator Antics B2"}, // Bouncy Bonanza B3 ?
    { 1, 0x39A01C,  0, {0x00, 0x71, 0x00, 0x86, 0x00, 0x00, 0x00, 0x02}, "Torchlight Trouble"},
    { 1, 0x39A01C,  0, {0x00, 0x6C, 0x00, 0x6D, 0x00, 0x00, 0x00, 0x01}, "TorchlightT B1&2 & ElevatorA B1 & ManicM B1&2"},
    { 1, 0x39AF65,  0, {0x00, 0x69, 0x00, 0x6D, 0x00, 0x01, 0x00, 0x02}, "Jungle Hijinxs B1"},
    { 1, 0x39AF65,  0, {0x00, 0xAF, 0x00, 0xB3, 0x00, 0x00, 0x00, 0x01}, "Barrel Cannon Canyon B1"},
    { 1, 0x39A01C,  0, {0x00, 0xAF, 0x00, 0xB3, 0x00, 0x00, 0x00, 0x01}, "BarrelCC B1 & TorchlightT B2 & MineCM B1"},
    { 1, 0x39A01C,  0, {0x00, 0xB5, 0x00, 0xBF, 0x00, 0x00, 0x00, 0x02}, "Winky Token Room"},
    { 1, 0x39AF65,  0, {0x00, 0xB0, 0x00, 0xB1, 0x00, 0x01, 0x00, 0x02}, "Banana Hoard"},
    { 1, 0x39A01C,  0, {0x00, 0x6F, 0x00, 0x71, 0x00, 0x00, 0x00, 0x02}, "Caves 9"},
    { 1, 0x39A01C,  0, {0x80, 0x4A, 0x80, 0x4C, 0x00, 0x01, 0x00, 0x02}, "Unused Caves Bonus"}, // 21

    { 2, 0x39A2DC,  0, {0x80, 0xCA, 0x40, 0xE0, 0x00, 0x00, 0x00, 0x02}, "Winky's Walkway"},
    { 2, 0x39A2DC,  0, {0x80, 0xC9, 0x80, 0xCA, 0x00, 0x01, 0x00, 0x02}, "WinkysW B1 & TrickTT B2&3 & MineCM B2 & TankedUT B1 & PlatformP B1&2"},
    { 2, 0x39A2DC,  0, {0x00, 0x00, 0x00, 0x3A, 0x00, 0x00, 0x00, 0x02}, "Mine Cart Madness"},
    { 2, 0x39A2DC,  0, {0x80, 0x6B, 0x80, 0x99, 0x00, 0x00, 0x00, 0x02}, "Trick Track Trek"},
    { 2, 0x39A2DC,  0, {0x80, 0xCA, 0x80, 0xCC, 0x00, 0x00, 0x00, 0x02}, "Trick Track Trek B1"},
    { 2, 0x39A2DC,  0, {0x80, 0x99, 0x80, 0xC9, 0x00, 0x00, 0x00, 0x02}, "Tanked Up Trouble"},
    { 2, 0x39A2DC,  0, {0x00, 0x3B, 0x80, 0x6B, 0x00, 0x00, 0x00, 0x02}, "Platform Perils"},
    { 2, 0x39A2DC,  0, {0x00, 0x3A, 0x00, 0x3B, 0x00, 0x00, 0x00, 0x01}, "Walkway 1"},
    { 2, 0x39A2DC,  0, {0x80, 0xC9, 0x80, 0xCA, 0x00, 0x00, 0x00, 0x01}, "Walkway 2"}, // 9

    { 3, 0x39A3DC,  0, {0x00, 0x01, 0x00, 0x03, 0x00, 0x00, 0x00, 0x02}, "Stop & Go Station B1"},
    { 3, 0x39A3DC,  0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02}, "Stop & Go Station B2"},
    { 3, 0x39A3DC,  0, {0x80, 0x34, 0x00, 0x5B, 0x00, 0x00, 0x00, 0x02}, "Stop & Go Station"},
    { 3, 0x39A3DC,  0, {0x00, 0x03, 0x80, 0x34, 0x00, 0x00, 0x00, 0x02}, "Misty Mine"},
    { 3, 0x39A3DC,  0, {0x00, 0x5B, 0x00, 0x62, 0x00, 0x01, 0x00, 0x02}, "Misty Mine B1"},
    { 3, 0x39A3DC,  0, {0x00, 0x5B, 0x00, 0x5C, 0x00, 0x00, 0x00, 0x01}, "Misty Mine B2"},
    { 3, 0x39A3DC, 59, {0x00, 0x62, 0x00, 0x91, 0x00, 0x00, 0x00, 0x02}, "Loopy Lights"},
    { 3, 0x39A3DC,  0, {0x00, 0x5E, 0x00, 0x62, 0x00, 0x00, 0x00, 0x01}, "Loopy Lights B1"},
    { 3, 0x39A3DC,  0, {0x00, 0x91, 0x00, 0x97, 0x00, 0x00, 0x00, 0x02}, "Loopy Lights B2"},
    { 3, 0x39A3DC,  0, {0x00, 0x5C, 0x00, 0x5E, 0x00, 0x00, 0x00, 0x01}, "Mines 6"},
    { 3, 0x39A3DC,  0, {0x00, 0x97, 0x00, 0x99, 0x00, 0x00, 0x00, 0x02}, "Mines 11"},
    { 3, 0x39A3DC,  0, {0x00, 0x99, 0x00, 0x9B, 0x00, 0x00, 0x00, 0x01}, "Mines 12"}, // 12

    { 4, 0x39B0A3,  0, {0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02}, "Oil Drum Alley FG"},
    { 4, 0x39B0A3, 63, {0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02}, "Blackout Basement FG"},
    { 4, 0x39B0A3,  0, {0x00, 0x02, 0x60, 0x2F, 0x00, 0x00, 0x00, 0x02}, "Oil Drum Alley"},
    { 4, 0x39B0A3,  0, {0x00, 0x5D, 0x00, 0x5E, 0x00, 0x00, 0x00, 0x02}, "Oil Drum Alley B1"},
    { 4, 0x39B0A3,  0, {0x00, 0x59, 0x00, 0x5A, 0x00, 0x01, 0x00, 0x02}, "Oil Drum Alley B2&3"},
    { 4, 0x39B0A3,  0, {0x00, 0x59, 0x00, 0x5D, 0x00, 0x00, 0x00, 0x01}, "Oil Drum Alley B4"},
    { 4, 0x39B0A3, 63, {0x60, 0x2F, 0x60, 0x58, 0x00, 0x00, 0x00, 0x02}, "Blackout Basement"},
    { 4, 0x39B0A3, 63, {0x00, 0x5E, 0x00, 0x60, 0x00, 0x00, 0x00, 0x02}, "Blackout Basement B1"},
    { 4, 0x39B0A3, 63, {0x00, 0x59, 0x00, 0x5A, 0x00, 0x01, 0x00, 0x02}, "Blackout Basement B2"},
    { 4, 0x39B0A3,  0, {0x00, 0x5A, 0x00, 0x5C, 0x00, 0x01, 0x00, 0x02}, "Factory 4"},
    { 4, 0x39B0A3,  0, {0x00, 0x5C, 0x00, 0x5D, 0x00, 0x01, 0x00, 0x02}, "Factory 5"},
    { 4, 0x39B0A3,  0, {0x00, 0x60, 0x00, 0x62, 0x00, 0x00, 0x00, 0x02}, "Factory 9"}, // 12

    { 5, 0x399C1C,  0, {0x00, 0x00, 0x00, 0x08, 0x00, 0x23, 0x80, 0x2A}, "Coral Capers"},
    { 5, 0x399C1C,  0, {0x00, 0x00, 0x00, 0x08, 0x80, 0x2A, 0xE0, 0x30}, "Clam City"},
    { 5, 0x399D1C,  0, {0x00, 0x00, 0x00, 0x08, 0x20, 0x0C, 0x40, 0x1D}, "Croctopus Chase"},
    { 5, 0x399F1C,  0, {0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x20, 0x0C}, "Poison Pond"},
    { 5, 0x399E1C,  0, {0x00, 0x00, 0x80, 0x05, 0x40, 0x1D, 0x00, 0x23}, "Enguarde Token Room"}, // 5

    { 6, 0x39B3A3,  0, {0x00, 0x08, 0x00, 0x34, 0x00, 0x00, 0x00, 0x02}, "Millstone Mayhem"},
    { 6, 0x39B3A3,  0, {0x00, 0x66, 0x00, 0x67, 0x00, 0x00, 0x00, 0x02}, "Millstone Mayhem B1"},
    { 6, 0x39B3A3,  0, {0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01}, "Temple Tempest B1"},
    { 6, 0x39B3A3,  0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x02}, "Millstone Mayhem B2&3 & Temple Tempest B1"},
    { 6, 0x39B3A3,  0, {0x00, 0x01, 0x00, 0x03, 0x00, 0x01, 0x00, 0x02}, "Temple 3"},
    { 6, 0x39B3A3,  0, {0x00, 0x04, 0x00, 0x06, 0x00, 0x00, 0x00, 0x02}, "Temple 4"},
    { 6, 0x39B3A3,  0, {0x00, 0x06, 0x00, 0x08, 0x00, 0x00, 0x00, 0x02}, "Temple 5"},
    { 6, 0x39B3A3,  0, {0x00, 0x34, 0x00, 0x66, 0x00, 0x00, 0x00, 0x02}, "Temple 7"}, // 8

    { 7, 0x399B1C,  0, {0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01}, "Snow BG"},
    { 7, 0x399B1C,  0, {0x00, 0x02, 0xE0, 0x38, 0x00, 0x00, 0x00, 0x02}, "Snow Barrel Blast"},
    { 7, 0x399B1C,  0, {0x00, 0x3A, 0x00, 0x3B, 0x00, 0x01, 0x00, 0x02}, "Snow Barrel Blast B1 & Ice Age Alley B2"},
    { 7, 0x399B1C,  0, {0x00, 0x39, 0x00, 0x3A, 0x00, 0x00, 0x00, 0x02}, "Snow Barrel Blast B2"},
    { 7, 0x399B1C,  0, {0x00, 0x3A, 0x00, 0x3E, 0x00, 0x00, 0x00, 0x01}, "Snow Barrel Blast B3"},
    { 7, 0x399B1C,  0, {0x00, 0x42, 0xA0, 0x6B, 0x00, 0x00, 0x00, 0x02}, "Ice Age Alley"},
    { 7, 0x399B1C,  0, {0x00, 0x40, 0x00, 0x42, 0x00, 0x00, 0x00, 0x02}, "Ice Age Alley B1"},
    { 7, 0x399B1C,  0, {0x00, 0x3B, 0x00, 0x3D, 0x00, 0x01, 0x00, 0x02}, "Snow 3"},
    { 7, 0x399B1C,  0, {0x00, 0x3E, 0x00, 0x40, 0x00, 0x00, 0x00, 0x02}, "Snow 5"},
    { 7, 0x399B1C,  0, {0xA0, 0x6B, 0xA0, 0x74, 0x00, 0x00, 0x00, 0x02}, "Rambi Token Room"}, // 10

    { 8, 0x39C723,  0, {0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01}, "Ice Cave BG"},
    { 8, 0x39C723,  0, {0x00, 0x00, 0x00, 0x08, 0x00, 0x01, 0x80, 0x0C}, "Slipslide Ride"},
    { 8, 0x39C723,  0, {0x00, 0x06, 0x00, 0x07, 0x00, 0x01, 0x00, 0x02}, "Slipslide Ride B1&2"},
    { 8, 0x39C723,  0, {0x00, 0x04, 0x00, 0x06, 0x80, 0x0C, 0x80, 0x0E}, "Slipslide Ride B3"},
    { 8, 0x39C723,  0, {0x00, 0x02, 0x00, 0x06, 0x00, 0x00, 0x00, 0x01}, "Ice Cave 1"},
    { 8, 0x39C723,  0, {0x00, 0x06, 0x00, 0x08, 0x00, 0x00, 0x00, 0x01}, "Ice Cave 2"},
    { 8, 0x39C723,  0, {0x00, 0x07, 0x00, 0x08, 0x00, 0x01, 0x00, 0x03}, "Ice Cave 4"},
    { 8, 0x39C723,  0, {0x00, 0x00, 0x00, 0x02, 0x80, 0x0C, 0x80, 0x0E}, "Ice Cave 5"},
    { 8, 0x39C723,  0, {0x00, 0x02, 0x00, 0x04, 0x80, 0x0C, 0x80, 0x0E}, "Ice Cave 6"}, // 9

    { 9, 0x399A14,  0, {0x00, 0x00, 0x00, 0x49, 0x00, 0x00, 0x00, 0x02}, "Mine Cart Carnage"},
    { 9, 0x399A14,  0, {0x00, 0x4B, 0x00, 0x94, 0x00, 0x00, 0x00, 0x02}, "Mine Cart Carnage BG"}, // 2

    {10, 0x39B2A3,  0, {0x00, 0x00, 0x00, 0x29, 0x00, 0x00, 0x00, 0x02}, "Tree Top Town"},
    {10, 0x39B2A3,  0, {0x00, 0x29, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x02}, "Tree Top Town B2"},
    {10, 0x39B2A3,  0, {0x00, 0x2A, 0x00, 0x2B, 0x00, 0x01, 0x00, 0x02}, "Tree Top Town B1 & Rope Bridge Rumble B2"},
    {10, 0x39B1A3,  0, {0x00, 0x2B, 0x00, 0x4E, 0x00, 0x00, 0x00, 0x02}, "Rope Bridge Rumble"},
    {10, 0x39B2A3,  0, {0x00, 0x4E, 0x00, 0x52, 0x00, 0x00, 0x00, 0x01}, "Rope Bridge Rumble B1"},
    {10, 0x39B2A3,  0, {0x00, 0x4E, 0x00, 0x50, 0x00, 0x01, 0x00, 0x02}, "Treetown 6"}, // 6

    {11, 0x39C623,  0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0xC0, 0x00}, "Forest BG"},
    {11, 0x39C623,  0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x02}, "Forest FG"},
    {11, 0x39C623,  0, {0x00, 0x02, 0x00, 0x2C, 0x00, 0x00, 0x00, 0x02}, "Vulture Culture"},
    {11, 0x39C623,  0, {0x00, 0x2C, 0x00, 0x2D, 0x00, 0x00, 0x00, 0x01}, "Vulture Culture B1&2 & Forest Frenzy B1"},
    {11, 0x39C623,  0, {0x00, 0x2C, 0x00, 0x30, 0x00, 0x01, 0x00, 0x02}, "Vulture Culture B3"},
    {11, 0x39C623,  0, {0x00, 0x30, 0x00, 0x59, 0x00, 0x00, 0x00, 0x02}, "Forest Frenzy"},
    {11, 0x39C623,  0, {0x00, 0x59, 0x00, 0x5B, 0x00, 0x00, 0x00, 0x02}, "Forest Frenzy B2"},
    {11, 0x39C623,  0, {0x00, 0x2D, 0x00, 0x2F, 0x00, 0x00, 0x00, 0x01}, "Forest 3"}, // 8

    {12, 0x39D363,  0, {0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01}, "Gang-Plank Galleon"},
    {12, 0x39D363,  0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x90, 0x01}, "Gang-Plank Galleon BG"},
    {13, 0x39CE63,  0, {0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01}, "Boss (Large)"},
    {13, 0x39CE63,  0, {0x00, 0x01, 0x00, 0x02, 0x00, 0x01, 0xE0, 0x01}, "Boss (Small)"},
    {13, 0x39CE63,  0, {0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x80, 0x01}, "Boss BG"},
    {13, 0x39CE63,  0, {0x00, 0x00, 0x00, 0x01, 0x80, 0x01, 0xE0, 0x01}, "Boss FG"} // 6

}; // 130

void level1 (unsigned char *rom, size_t rom_size, char *dir, int priority, int mode, int tileset) {

    const int screen_count = (mode == 2) ? 14 : 130; // Layouts vs. Levels

    #pragma omp parallel for schedule(dynamic)
    for (int i = 0; i < screen_count; i++) {

        unsigned char *bitplane = NULL;
        unsigned char *bp_data  = NULL;
        unsigned char *lay_data = NULL;
        unsigned char *raw_data = NULL;
        size_t bp_len   = 0;
        int raw_counter = 0;
        int lay_counter = 0;
        int vert, layout_size;
        unsigned char coords[10] = { 0xFF, 0xFF };
        const struct DKC_AREA  *area  = &areas[i];
        const struct DKC_ARCH  *arch;
        const struct DKC_LEVEL *level;
        int archn;

        if (mode == 2) {
            archn = i;
            level = &levels[i];
        }
        else {
            archn = levels[area->type].arch;
            level = &levels[archn];
        }
        arch = &archetype[archn];

        raw_data    = &rom[arch->raw_loc];
        raw_counter =      arch->raw_len;
        lay_data    = &rom[level->lay_loc];
        lay_counter =      level->lay_len;

        if (tileset) {
            int duplicate = 0;
            for (int j = 0; j < i; j++) {
                const struct DKC_AREA *b = &areas[j];
                if (area->type    == b->type
                &&  area->pal_ofs == b->pal_ofs
                &&  area->pal_fix == b->pal_fix) {
                    duplicate = 1;
                    break;
                }
            }
            if (duplicate)
                continue;
        }

        if (archn == 12) { /* Gang-Plank Galleon */
            bp_len = 0x8000;
            bp_data = malloc(0x8000);
            if (bp_data == NULL)
                goto error;
            memcpy(bp_data, &rom[0x0F0000], bp_len);
        }
        else { /* everything else */
            size_t bp_loc = arch->bp_loc;
            if (dk_decompress_mem_to_mem(DKCHR_DECOMP, &bp_data, &bp_len, &rom[bp_loc], rom_size - bp_loc))
                goto error;
        }

        if (archn == 6) { /* Temple Fix */
            /* realloc probably isn't needed */
            unsigned char *z = realloc(bp_data, bp_len + 0x22A0);
            if (z == NULL)
                goto error;
            bp_data = z;
            memmove(&bp_data[0x22A0], bp_data, bp_len);
            memcpy (&bp_data[0x22C0], &rom[0x1300C0], 0xC0);
            bp_len += 0x22A0;
        }

        /* Some arches have unusual dimensions */
        if (archn == 5 || archn == 8) {
            vert = 1;
            layout_size = 64;
        }
        else {
            vert = 0;
            layout_size = 16;
        }

        memcpy(&coords[2], &area->crop, 8);

        bitplane = malloc((lay_counter / 2) * 1024 * 4);
        if (bitplane == NULL)
            goto error;

        // dump_bitplane(&bp_data, bp_len, 4, 16, dir, "Bitplane");

        if (mode == 2) { /* Complete Layouts */
            decode_bitplane(rom, bp_data, raw_data, bitplane, level->pal_ofs, raw_counter, bp_len, 1, 0, priority);
            assemble_level(bitplane, rom, lay_data, lay_counter, 0, vert, layout_size, 0, dir, level->name);
        }
        else {
            decode_bitplane(rom, bp_data, raw_data, bitplane, area->pal_ofs, raw_counter, bp_len, 1, area->pal_fix, priority);
            if (tileset) /* Tilesets */
                assemble_bitplane(bitplane, 512, raw_counter, dir, area->name);
            else /* Levels */
                assemble_level(bitplane, coords, lay_data, lay_counter, 1, vert, layout_size, 0, dir, area->name);
        }

cleanup:
        free(bp_data);
        free(bitplane);
        continue;
error:
        fprintf(stderr, "Allocation error. (%d)\n", i);
        goto cleanup;
    }

    return;

} // main()
