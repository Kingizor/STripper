#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include "bitplane.h"

struct dkl_arch {
    uint8_t bp_val; // Bitplane Decompression
    uint8_t tiles;  // Number of tiles
    uint8_t lay[3]; // 32x32 Locations
};

struct dkl_levels {
    uint8_t arch;    // Archetype
    uint8_t t_width; // Level Width (32x32)
    uint8_t raw[3];  // RAW Decompression
    uint16_t pal;    // SGB Palette Address
    char *name;      // Level Name
};

struct dkl2_levels {
    uint8_t t_width;  // Level Width (32x32)
    uint8_t arch;     // Archetype
    uint8_t rf1[2];   // Raw Fixes Part 1
    uint8_t rf2[2];   // Raw Fixes Part 2
    uint8_t raw[3];   // RAW Decompression
    char *name;       // Level Name
};

struct dkl2_arches {
    uint8_t bp_bank[4]; // Bitplane Decompression
    uint8_t lay[3];     // 32x32 Locations
    uint8_t tiles;      // Number of 
    uint8_t pal[8];     // SGB Palette (Archetype specific)
};

struct dkl3_levels {
    uint8_t t_width;  // Level Width (32x32)
    uint8_t arch;     // Archetype
    uint8_t rf1[2];   // Raw Fixes Part 1
    uint8_t rf2[2];   // Raw Fixes Part 2
    uint8_t raw[3];   // RAW Decompression
    uint8_t pal[8];   // SGB Palette (Level specific)
    char *name;       // Level Name
};

struct dkl3_arches {
    uint8_t bp_bank[4]; // Bitplane Decompression
    uint8_t lay[3];     // 32x32 Locations
    uint8_t tiles;      // Number of tiles in tileset
};


static inline void rl(uint8_t *x, uint8_t *carry) {

    uint8_t temp = *carry;
    *carry = (*x & 0x80) ? 1 : 0;
    *x <<= 1;
    *x += temp;

} // rl();

static inline void rr(uint8_t *x, uint8_t *carry) {

    uint8_t temp = *carry;
    *carry = (*x & 1) ? 1 : 0;
    *x >>= 1;
    if (temp) *x += 0x80;

} // rr();

static inline void swap_n(uint8_t *x) {
    
    uint8_t n;
    n = *x & 0x1F;
    *x >>= 4;
    *x += n << 4;
    
} // swap();

static void sr_0A8C(uint8_t *rom, int bank, uint8_t *a, uint8_t *c, uint8_t *d, uint8_t *e, uint8_t *carry) {

    *a = rom[bank+((*d - 0x40)*256)+*e];
    *a &= *c;
    swap_n(c);
    *carry = 0;
    if (*c & 0x80) {
        if (*e + 1 > 255) *d += 1;
        *e += 1;
    }
    else {
        swap_n(a);
        *carry = 0;
    }
    return;

} // sr_0A8C();

static void dkl_raw(uint8_t *rom, uint8_t *output, int *rawlen, int bank, uint8_t d, uint8_t e) {

    uint8_t a = 0, b = 0, c = 0xF0, h = 0, l = 0, t9B = 0, t9C = 0, carry = 0;
    int jmp = 0x975;
    int ret; // Return Address
    int run = 1;
    int wpos = 0; // Write Position
    uint8_t stack[8];
    int sc = 0;
    // int count;
    bank *= 0x4000;
    
    while (run) {
    
        // printf("\n%d:\n", count);
        // printf("\t j = %04X\n", jmp);
        // printf("\t a = %02X\n", a);
        // printf("\tbc = %04X\n", (b*256)+c);
        // printf("\tde = %04X\n", (d*256)+e);
        // printf("\thl = %04X\n", (h*256)+l);
        // printf("\t c = %X\n", carry);
        // printf("\twp = %X\n", wpos);
        // count++;
        // if (count > 1000) run = 0;
        // if (wpos > 0xFFF) run = 0;
        
        switch (jmp) {
        
            case 0x975:
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                if (a < 0x0C) {
                    carry = 1;
                    jmp = 0x97C;
                }
                else {
                    carry = 0;
                    jmp = 0x9D0;
                }
            break;
            
            case 0x97C:
                b = a;
                swap_n(&b);
                carry = 0;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                a |= b;
                if (a == 0xBE) {
                    jmp = 0x98C;
                }
                else if (a > 0xBE) {
                    jmp = 0x9A7;
                }
                else {
                    output[wpos] = a;
                    wpos++;
                    jmp = 0x975;
                }
            break;
            
            case 0x98C:
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                b = a;
                swap_n(&b);
                carry = 0;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                a |= b;
                t9B = a;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                a += 3;
                b = a;
                a = t9B;
                jmp = 0x9A0;
            break;
            
            case 0x9A0:
                output[wpos] = a;
                wpos++;
                a++;
                b--;
                jmp = (b > 0) ? 0x9A0 : 0x975;
            break;
            
            case 0x9A7:
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                b = a;
                swap_n(&b);
                carry = 0;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                a |= b;
                t9B = a;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                b = a;
                swap_n(&b);
                carry = 0;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                a |= b;
                t9C = a;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                if (a > 0xFD) carry = 1;
                a += 2;
                b = a;
                jmp = 0x9C5;
            break;
            
            case 0x9C5:
                a = t9B;
                output[wpos] = a;
                wpos++;
                a = t9C;
                output[wpos] = a;
                wpos++;
                b--;
                jmp = (b > 0) ? 0x9C5 : 0x975;
            break;
            
            case 0x9D0:
                a -= 0xD;
                jmp = (a < 0xF3) ? 0xA1A : 0x9D4;
            break;
            
            case 0x9D4:
                a = 0;
                t9C = a;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                b = a;
                swap_n(&b);
                carry = 0;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                a |= b;
                t9B = a;
                rr(&a, &carry);
                jmp = carry ? 0x9E6 : 0x9EB;
            break;
            
            case 0x9E6:
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                t9C = a;
                jmp = 0x9EB;
            break;
            
            case 0x9EB:
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                jmp = (a == 0xF) ? 0x9F2 : 0x9FC;
            break;
            
            case 0x9F2:
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                b = a;
                swap_n(&b);
                carry = 0;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                a |= b;
                jmp = 0x9FC;
            break;
            
            case 0x9FC:
                a += 4;
                b = a;
                stack[sc] = d;
                sc++;
                stack[sc] = e;
                sc++;
                a = t9C;
                if (a & 1) carry = 1;
                a >>= 1;
                d = a;
                a = t9B;
                rr(&a, &carry);
                e = a;
                
                h = ((wpos - (wpos % 256)) / 256) + 0xCC;
                l = wpos % 256;
                
                a = l;
                carry = (a < e) ? 1 : 0;
                a -= e;
                e = a;
                a = h;
                a -= d;
                if (carry) a--;
                d = a;
                if (e == 0) d--;
                e--;
                jmp = 0xA10;
            break;
            
            case 0xA10:
                a = output[((d-0xCC)*256)+e];
                if ((e+1) > 255) d++;
                e++;
                output[wpos] = a;
                wpos++;
                b--;
                jmp = (b > 0) ? 0xA10 : 0xA16;
            break;
            
            case 0xA16:
                sc--;
                e = stack[sc];
                sc--;
                d = stack[sc];
                
                jmp = 0x975;
            break;
            
            case 0xA1A:
                jmp = (!a) ? 0xA1C : 0xA3B;
            break;
            
            case 0xA1C:
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                swap_n(&a);
                carry = 0;
                b = a;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                
                stack[sc] = h;
                sc++;
                stack[sc] = l;
                sc++;
                
                l = a;
                swap_n(&l);
                carry = 0;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                a |= l;
                
                sc--;
                h = stack[sc];
                sc--;
                h = stack[sc];
                
                stack[sc] = a;
                sc++;
                stack[sc] = carry;
                sc++;
                
                a = 0x13;
                stack[sc] = b;
                sc++;
                stack[sc] = c;
                sc++;
                jmp = 0xA52;
                ret = 0xA35;
            break;
            
            case 0xA35:
                sc--;
                carry = stack[sc];
                sc--;
                a = stack[sc];
                
                b = a;
                
                sc--;
                carry = stack[sc];
                sc--;
                a = stack[sc];
                
                a++;
                jmp = 0xA4C;
            break;
            
            case 0xA3B:
                a--;
                jmp = (!a) ? 0xA3E : 0xA60;
            break;
            
            case 0xA3E:
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                if (a == 0x0E) run = 0; // QUIT
                jmp = 0xA44;
            break;
            
            case 0xA44:
                swap_n(&a);
                carry = 0;
                b = a;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                a += 4;
                jmp = 0xA4C;
            break;
            
            case 0xA4C:
                jmp = 0xA52;
                ret = 0x975;
            break;
            
            case 0xA52:
                output[wpos] = b;
                b = a;
                do {
                    sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                    a |= output[wpos];
                    output[wpos] = a;
                    wpos++;
                    a &= 0xF0;
                    output[wpos] = a;
                    b--;
                } while (b > 0);
                jmp = ret;
            break;
            
            case 0xA60:
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                b = a;
                swap_n(&b);
                carry = 0;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                a |= b;
                t9B = a;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                jmp = (a & 8) ? 0xA77 : 0xA73; // Double Check This...
            break;
            
            case 0xA73:
                a += 3;
                jmp = 0xA82;
            break;
            
            case 0xA77:
                a &= 7;
                swap_n(&a);
                carry = 0;
                b = a;
                sr_0A8C(rom, bank, &a, &c, &d, &e, &carry);
                a |= b;
                a += 0xB;
                jmp = 0xA82;
            break;
            
            case 0xA82:
                b = a;
                a = t9B;
                jmp = 0xA85;
            break;
            
            case 0xA85:
                output[wpos] = a;
                wpos++;
                b--;
                jmp = (b > 0) ? 0xA85 : 0x975;
            break;
            
            default:
                run = 0;
                printf("Unknown Case: %04X\n", jmp);
            break;
        
        }
        
    }
    
    *rawlen = wpos;
    
}

static void dkl_tiles(uint8_t *rom, uint8_t *output, int *bp_len, uint8_t a) {

    int run = 1, jmp = 0x0CDB, bank;
    uint8_t b = 0, c = 0, d = 0, e = 0, h = 0, l = 0, a3 = 0, carry = 0;
    uint16_t hl, sp;
    
    d = 0;
    e = a;
    hl = a;
    hl *= 5;
    hl += 0x4001;
    bank = (7 * 0x4000) - 0x4000; // DE - 0x4000
    a = rom[bank+hl];
    a3 = a;
    // a4 = sp;
    sp = hl;
    sp++;
    l = rom[bank+sp];
    sp++;
    h = rom[bank+sp];
    sp++;
    e = rom[bank+sp];
    sp++;
    d = rom[bank+sp];
    a = e;
    a &= 0x0F;
    if (!a) a = 0x12;
    bank = (a * 0x4000) - 0x4000;
    sp = (h*256)+l;
    a = e;
    a &= 0xF0;
    l = a;
    a = a3;
    if (!a) {
        printf("Exit@ 0x0CA7 in dkc_tiles();\n");
        return;
    }
    
    e = l;
    l = 0xFE;
    jmp = 0xCDB;
    // int count = 0;
    
    while (run) {
    
        // printf("\ncount = %d\n", count);
        // printf("jmp = 0x%04X\n", jmp);
        // printf("\ta  = %02X\n", a);
        // printf("\tbc = %04X\n", (b*256)+c);
        // printf("\tde = %04X\n", (d*256)+e);
        // printf("\thl = %04X\n", (h*256)+l);
        // printf("\tsp = %04X\n", sp);
        // printf("\tc  = %d\n", carry);
        // count++;
        // if (count > 1000) return;
    
        switch(jmp) {
        
            case 0xCDB:
                c = rom[bank+sp];
                sp++;
                b = rom[bank+sp];
                sp++;
                sp--;
                b = 8;
                jmp = 0xCE5;
            break;
            
            case 0xCE1:
                l = rom[(h*256)+l];
                jmp = 0xCE2;
            break;
            
            case 0xCE2:
                b--;
                jmp = b ? 0xCE5 : 0xCDB;
            break;
            
            case 0xCE5:
                h = 0x3F;
                a = rom[(h*256)+l];
                h--;
                rl(&c, &carry);
                jmp = carry ? 0xCF0 : 0xCED;
            break;
            
            case 0xCED:
                h--;
                swap_n(&a);
                jmp = 0xCF0;
            break;
            
            case 0xCF0:
                rl(&a, &carry);
                jmp = (carry) ? 0xCE1 : 0xCF3;
            break;
            
            case 0xCF3:
                a = rom[(h*256)+l];
                output[(d*256)+e-0x8000] = a;// WRITE
                *bp_len = *bp_len + 1;
                e++;
                l = 0xFE;
                a = e;
                a &= 0x0F;
                jmp = a ? 0xCE2 : 0xCFD;
            break;
            
            case 0xCFD:
                a ^= e;
                jmp = a ? 0xD08 : 0xD00;
            break;
            
            case 0xD00:
                d++;
                a = d;
                if (a == 0x98) d = 0x88;
                jmp = 0xD08;
            break;
            
            case 0xD08:
                a = a3;
                a--;
                a3 = a;
                run = a3;
                jmp = 0xCE2;
            break;
        
        } // switch();
    
    } // while();
    
    return;

} // dkl_tiles();

static void dkl_layout(uint8_t *rom, uint8_t *raw_data, uint8_t *lay_data, uint8_t arch, int bank, uint8_t width, uint8_t height) {
    
    int val;
    int i, j, k, m;
    
    for (i = 0; i < height; i++) {
        for (j = 0; j < width; j++) {
            
            val = raw_data[(i*width)+j];
            
            if (val > 255) {
                printf("Error: Tile greater than 255 detected.\n");
            }
            
            for (k = 0; k < 4; k++) {
                for (m = 0; m < 4; m++) {
                    
                    int addr = (i*width*16)+(j*4)+(k*width*4)+m;
                    int tile = rom[bank+val+(k*0x400)+(m*0x100)+arch];
                    
                    lay_data[addr] = tile;
                }
            }
        }
    }
    
    return;
    
} // dkl_layout();

void dkl_levels(uint8_t *rom, char *dir, uint8_t sgb, int tileset) {

    uint8_t *bp_data = calloc(0x2000, 1);
    int bp_len = 0;
    
    uint8_t *lay_data = calloc(0x20000, 1);
    uint8_t *rgb = calloc(384, 1);
    uint8_t *bitplane = calloc(0x4000000, 1);
    
    uint8_t *raw_data = calloc(0x4000, 1);
    int rawlen = 0;
    int t_width, t_height;
    char name[255];
    
    struct dkl_arch arch[] = {
        {0x00, 113, {0x82, 0x01, 0x03}}, // Jungle
        {0x1A,  94, {0x00, 0x01, 0x03}}, // Cave
        {0x18,  52, {0x80, 0x07, 0x03}}, // Water Temple
        {0x06,  70, {0x00, 0x07, 0x02}}, // Snow
        {0x0E,  69, {0x00, 0x07, 0x01}}, // Mast
        {0x1C, 128, {0x00, 0x07, 0x03}}, // Construction (5)
        {0x17,  74, {0xB4, 0x07, 0x03}}, // Blimp
        {0x0A,  79, {0x46, 0x07, 0x02}}, // Temple
        {0x0C,  66, {0x45, 0x07, 0x01}}, // Coral
        {0x1D, 113, {0x87, 0x07, 0x01}}, // Cloud
        {0x1B,  36, {0x5E, 0x01, 0x03}}, // Mountain (10)
        {0x19, 107, {0x95, 0x07, 0x02}}, // Skyscraper
    };
    
    struct dkl_levels dkl[] = {
        { 0, 0x7C, {0x0D, 0x48, 0x1D}, 0xE936, "1-1 Jungle Jaunt"},
        { 1, 0x0F, {0x0D, 0x7F, 0x3B}, 0xE966, "1-1 Jungle Jaunt B1"},
        { 2, 0x0E, {0x07, 0x4D, 0x85}, 0xE9DE, "1-1 Jungle Jaunt B2"},
        { 3, 0xD4, {0x0D, 0x40, 0xDF}, 0xE92E, "1-2 Freezing Fun"},
        { 0, 0x05, {0x06, 0x7E, 0x5E}, 0xE92E, "1-2 Freezing Fun B1"},
        { 0, 0x91, {0x0D, 0x4A, 0xFC}, 0xE976, "1-3 Simian Swing"},
        { 1, 0x09, {0x0D, 0x7E, 0xD1}, 0xE956, "1-3 Simian Swing B1"},
        { 0, 0x05, {0x06, 0x7E, 0x5E}, 0xE9A6, "1-3 Simian Swing B2"},
        { 4, 0x10, {0x0D, 0x63, 0xAB}, 0xE986, "1-4 Deck Trek"},
        { 5, 0x08, {0x11, 0x7F, 0xA0}, 0xE9AE, "1-4 Deck Trek B1"},
        { 0, 0x0F, {0x0E, 0x7F, 0x79}, 0xE93E, "1-4 Deck Trek B2"},
        { 3, 0xB5, {0x0D, 0x44, 0xDB}, 0xE97E, "1-5 Rope Ravine"},
        { 0, 0x05, {0x06, 0x7E, 0x5E}, 0xE9AE, "1-5 Rope Ravine B1"},
        { 2, 0x0E, {0x07, 0x4D, 0x3D}, 0xE9E6, "1-5 Rope Ravine B2"},
        { 0, 0x8E, {0x0D, 0x4E, 0x38}, 0xE996, "1-6 Tyre Trail"},
        { 0, 0x05, {0x06, 0x7E, 0x5E}, 0xE9A6, "1-6 Tyre Trail B1"},
        { 1, 0x05, {0x0D, 0x7E, 0xB5}, 0xE94E, "1-6 Tyre Trail B2"},
        { 1, 0x0F, {0x0D, 0x7E, 0xFF}, 0xE95E, "1-6 Tyre Trail B3"},
        { 4, 0xFA, {0x0D, 0x5E, 0x39}, 0xE956, "1-7 Riggin' Rumble"},
        { 6, 0x0A, {0x09, 0x7F, 0xD1}, 0xE92E, "1-7 Riggin' Rumble B1"},
        { 0, 0x0D, {0x0E, 0x7F, 0xB3}, 0xE946, "1-7 Riggin' Rumble B2"},
        { 0, 0x98, {0x0D, 0x51, 0xE3}, 0xE93E, "1-8 Congo Carnage"},
        { 4, 0x07, {0x06, 0x7E, 0x79}, 0xE96E, "1-8 Congo Carnage B1"},
        { 0, 0x05, {0x06, 0x7E, 0x5E}, 0xE9AE, "1-8 Congo Carnage B2"},
        { 3, 0xAE, {0x0E, 0x76, 0xF8}, 0xE9EE, "1-9 Arctic Barrel Arsenal"},
        { 0, 0x05, {0x06, 0x7E, 0x5E}, 0xE996, "1-9 Arctic Barrel Arsenal B1"},
        { 5, 0x0B, {0x11, 0x7F, 0xC5}, 0xE9A6, "1-9 Arctic Barrel Arsenal B2"},
        { 4, 0x05, {0x0D, 0x7F, 0xDC}, 0xE97E, "1-B Wild Sting Fling"},
        
        { 7, 0xB8, {0x0D, 0x55, 0x21}, 0xE946, "2-1 Tricky Temple"},
        { 5, 0x29, {0x06, 0x7E, 0xC5}, 0xE98E, "2-1 Tricky Temple B1"},
        { 2, 0xB6, {0x0D, 0x7B, 0x27}, 0xE9AE, "2-2 Kremlantis"},
        { 8, 0x35, {0x0D, 0x65, 0xC9}, 0xE94E, "2-3 Reef Rampage"},
        { 7, 0xC8, {0x0D, 0x58, 0x36}, 0xE966, "2-4 Snake Charmer's Challenge"},
        { 9, 0x22, {0x07, 0x4D, 0xC8}, 0xE9CE, "2-4 Snake Charmer's Challenge B1"},
        { 2, 0x8A, {0x06, 0x76, 0xC2}, 0xEA16, "2-5 Chomp's Coliseum"},
        { 8, 0x3E, {0x0D, 0x6C, 0x5E}, 0xE95E, "2-6 Nautilus Chase"},
        { 7, 0xB3, {0x0D, 0x5B, 0x4B}, 0xE96E, "2-7 Swirlwind Storm"},
        { 5, 0x1D, {0x06, 0x7F, 0x6C}, 0xE996, "2-7 Swirlwind Storm B1"},
        { 2, 0x05, {0x0E, 0x7F, 0xED}, 0xE9FE, "2-B Seabed Showdown"},
        
        { 1, 0xAC, {0x0E, 0x56, 0xEF}, 0xE9BE, "3-1 Pot Hole Panic"},
        { 6, 0x19, {0x0B, 0x7F, 0x26}, 0xEA0E, "3-1 Pot Hole Panic B1"},
        { 4, 0x05, {0x0D, 0x7F, 0xDC}, 0xE94E, "3-1 Pot Hole Panic B2"},
        {10, 0x29, {0x0E, 0x5B, 0x6D}, 0xE9C6, "3-2 Mountain Mayhem"},
        { 4, 0x20, {0x0D, 0x7F, 0x80}, 0xE976, "3-2 Mountain Mayhem B1"},
        { 6, 0x05, {0x07, 0x4C, 0xD7}, 0xE966, "3-2 Mountain Mayhem B2"},
        { 9, 0x8B, {0x0E, 0x67, 0xF6}, 0xE9DE, "3-3 Track Attack"},
        { 1, 0x05, {0x0D, 0x7E, 0xB5}, 0xE946, "3-3 Track Attack B1"},
        { 6, 0x05, {0x07, 0x4C, 0xD7}, 0xEA16, "3-3 Track Attack B2"},
        { 1, 0xAF, {0x06, 0x79, 0x1E}, 0xEA26, "3-4 Spiky Tyre Trail"},
        { 0, 0x05, {0x06, 0x7E, 0x5E}, 0xE93E, "3-4 Spiky Tyre Trail B1"},
        { 0, 0x05, {0x06, 0x7E, 0x5E}, 0xE98E, "3-4 Spiky Tyre Trail B2"},
        { 9, 0x30, {0x0E, 0x6B, 0xE4}, 0xE9E6, "3-5 Sky High Caper"},
        { 2, 0x20, {0x09, 0x7F, 0x66}, 0xE9F6, "3-5 Sky High Caper B1"},
        {10, 0xC6, {0x09, 0x7A, 0x88}, 0xEA0E, "3-6 Landslide Leap"},
        { 1, 0x0F, {0x0D, 0x7E, 0xFF}, 0xE996, "3-6 Landslide Leap B1"},
        { 6, 0x11, {0x0B, 0x7F, 0x80}, 0xEA1E, "3-6 Landslide Leap B2"},
        { 9, 0xBD, {0x0E, 0x71, 0xBD}, 0xE9FE, "3-7 Collapsing Clouds"},
        { 6, 0x09, {0x0B, 0x7F, 0x03}, 0xE976, "3-7 Collapsing Clouds B1"},
        { 0, 0x05, {0x06, 0x7E, 0x5E}, 0xE9AE, "3-7 Collapsing Clouds B2"},
        { 1, 0x05, {0x07, 0x4E, 0x9C}, 0xEA2E, "3-B Mad Mole Holes"},
        
        {11, 0x9B, {0x0E, 0x40, 0x01}, 0xE9B6, "4-1 Construction Site Fight"},
        { 9, 0x15, {0x07, 0x4F, 0x86}, 0xE9B6, "4-1 Construction Site Fight B1"},
        { 9, 0x24, {0x07, 0x4E, 0xB6}, 0xE9D6, "4-1 Construction Site Fight B2"},
        { 6, 0xBD, {0x0D, 0x76, 0xBE}, 0xE9A6, "4-2 Kong Krazy"},
        { 5, 0x08, {0x11, 0x7F, 0xA0}, 0xE956, "4-2 Kong Krazy B1"},
        { 5, 0x9C, {0x0E, 0x5F, 0x8A}, 0xE9D6, "4-3 Balloon Barrage"},
        { 6, 0x0A, {0x09, 0x7F, 0xD1}, 0xE96E, "4-3 Balloon Barrage B1"},
        { 6, 0x0C, {0x0B, 0x7F, 0xB3}, 0xE936, "4-3 Balloon Barrage B2"},
        { 6, 0xB3, {0x0E, 0x7A, 0x45}, 0xE9F6, "4-4 Fast Barrel Blast"},
        { 0, 0x05, {0x06, 0x7E, 0x5E}, 0xE9A6, "4-4 Fast Barrel Blast B1"},
        { 0, 0x0A, {0x0E, 0x7F, 0x47}, 0xE936, "4-4 Fast Barrel Blast B2"},
        {11, 0xC9, {0x0E, 0x45, 0xFB}, 0xE9CE, "4-5 Skyscraper Caper"},
        { 2, 0x05, {0x0E, 0x7F, 0xED}, 0xE95E, "4-5 Skyscraper Caper B1"},
        { 5, 0x8E, {0x0E, 0x64, 0x17}, 0xEA1E, "4-6 Button Barrel Blast"},
        { 1, 0x09, {0x0D, 0x7E, 0xD1}, 0xE98E, "4-6 Button Barrel Blast B1"},
        { 0, 0x0A, {0x0E, 0x7F, 0x47}, 0xE98E, "4-6 Button Barrel Blast B2"},
        {11, 0x29, {0x0E, 0x4F, 0x08}, 0xEA06, "4-7 Oil Drum Slum"},
        { 2, 0x26, {0x07, 0x4C, 0xEA}, 0xE9EE, "4-7 Oil Drum Slum B1"},
        { 4, 0x07, {0x06, 0x7E, 0x79}, 0xE97E, "4-7 Oil Drum Slum B2"},
        { 6, 0x09, {0x0B, 0x7F, 0x03}, 0xEA06, "4-B K. Rool's Kingdom"}
    };
    
    
    int a, i, bank;
    uint8_t bw[] = {0xBD, 0x77, 0x94, 0x52, 0xAD, 0x35, 0x42, 0x08}; // 16, 88, 160, 232
    // uint8_t skyfix[] = {0x12, 0xFF, 0x1F, 0xFF, 0x1F, 0xFF, 0x1F, 0xFF, 0x1F, 0xFF, 0x1F, 0xFF, 0x1F, 0xFF, 0x1F, 0xFF};
    
    // rom[0x1E2A8] = 0x1C;
    
    int size = sizeof(dkl) / sizeof(struct dkl_levels);
    
    for (i = 0; i < size; i++) {
    
        a = dkl[i].arch;
        rawlen = 0;
        bp_len = 0;
        
        memset(raw_data, 0, 0x4000);
        if (!tileset) {
            dkl_raw(rom, raw_data, &rawlen, dkl[i].raw[0], dkl[i].raw[1], dkl[i].raw[2]);
            t_width  = dkl[i].t_width;
            t_height = rawlen / dkl[i].t_width;
        }
        else {
            tile_generator(raw_data, &rawlen, arch[a].tiles, 0);
            t_width = 16;
            t_height = (rawlen / t_width);
            if (rawlen % t_width) t_height++;
        }
        
        // Decompress bitplane data
        dkl_tiles(rom, bp_data, &bp_len, arch[a].bp_val);
        memmove(&bp_data[0], &bp_data[0x1000], 0x800);
        
        // Skyscraper Rope Fix
        if (arch[a].lay[0] == 0x95) {
            memcpy(&bp_data[0x1000], &bp_data[0x1C0], 16);
            memcpy(&bp_data[0x1C0], &bp_data[0x1D0], 16);
            memcpy(&bp_data[0x1D0], &bp_data[0x1000], 16);
        }
        
        bank = ((arch[a].lay[1] * 0x4000) + (arch[a].lay[2] * 0x1000));
        
        // Assemble complete layout from lay and raw
        dkl_layout(rom, raw_data, lay_data, arch[a].lay[0], bank, t_width, t_height);
        
        if (sgb == 5) {
            decode_palette(rgb, &bw[0], 4);
        }
        else {
            decode_palette(rgb, &rom[dkl[i].pal], 4);
        }
        
        gbc_assemble(bitplane, bp_data, lay_data, lay_data, rgb, t_width, t_height, 0);
        
        strcpy(name, dkl[i].name);
        if (tileset) strcat(name, " Tiles");
        strcat(name, ".png");
        arrange_gbc(bitplane, (t_width*32), (t_height*32), dir, name);
        
    }
    
    free(bp_data);
    free(lay_data);
    free(raw_data);
    free(rgb);
    free(bitplane);
    
    return;

} // dkl_levels();

static void dkl2_tiles(uint8_t *rom, uint8_t *output, int *bp_len, int bank, int sc, uint8_t tAD) {

    int run = 1;
    int jmp = 0xA39;
    uint8_t a = 0, b = 0, c = 0, d = 0x90, e = 0, h = 0, l = 0xFE, carry = 0;
    int wpos = *bp_len;
    // int count = 0;
    bank *= 0x4000;
    
    // FILE *out = fopen("output.txt", "w");
    
    while (run) {
        
        // fprintf(out, "\n\n%d:", count);
        // fprintf(out, "\n\tj  = %X", jmp);
        // fprintf(out, "\n\ta  = %02X", a);
        // fprintf(out, "\n\tbc = %04X", (b*256)+c);
        // fprintf(out, "\n\tde = %04X", (d*256)+e);
        // fprintf(out, "\n\thl = %04X", (h*256)+l);
        // fprintf(out, "\n\tsc = %04X", sc);
        // fprintf(out, "\n\tc  = %X", carry);
        // fprintf(out, "\n\twp = %X", wpos);
        // fprintf(out, "\n\tAD = %X", tAD);
        // count++;
        // if (c > 100) run = 0;
        
        switch(jmp) {
        
            case 0xA39:
                c = rom[bank + sc];
                sc++; // +2, -1
                if (sc > 0x3FFF) sc = 0;
                b = 0x08;
                jmp = 0xA43;
            break;
            
            case 0xA3F:
                l = rom[(h*256)+l];
                jmp = 0xA40;
            break;
            
            case 0xA40:
                b--;
                jmp = b ? 0xA43 : 0xA39;
            break;
            
            case 0xA43:
                h = 0x3F;
                a = rom[(h*256)+l];
                h--;
                rl(&c, &carry);
                jmp = (carry) ? 0xA4E : 0xA4B;
            break;
            
            case 0xA4B:
                h--;
                swap_n(&a);
                jmp = 0xA4E;
            break;
            
            case 0xA4E:
                rl(&a, &carry);
                jmp = (carry) ? 0xA3F : 0xA51;
            break;
            
            case 0xA51:
                a = rom[(h*256)+l];
                output[wpos] = a;
                wpos++;
                if ((e+1) > 255) d++;
                e++;
                l = 0xFE;
                a = e;
                a &= 0x0F;
                jmp = a ? 0xA40 : 0xA5B;
            break;
            
            case 0xA5B:
                a ^= e;
                jmp = a ? 0xA66 : 0xA5E;
            break;
            
            case 0xA5E:
                d++;
                a = d;
                if (a < 0x98) {
                    carry = 1;
                }
                else if (a < 0x98) {
                    d = 0x88;
                }
                jmp = 0xA66;
            break;
            
            case 0xA66:
                a = tAD;
                a--;
                tAD = a;
                if (a > 0) {
                    jmp = 0xA40;
                }
                else {
                    run = 0;
                }
            break;
        
        }
    
    }
    // fclose(out);
    *bp_len = wpos;
    
    return;

} // dkl2_tiles();

static void dkl2_raw_fix(uint8_t *rom, uint8_t *raw_data, int rawlen, int addr, int bank) {

    int i;
    
    for (i = 0; i < rawlen; i++) {
    
        if (raw_data[i] & 0x80) {
            raw_data[i] = rom[addr] & 0x7F;
            addr++;
            raw_data[i] = rom[bank + (raw_data[i] * 3)];
        }
    }
    // printf("%d bytes replaced.\n", count);

} // dkl2_raw_fix();

void dkl2_levels(uint8_t *rom, char *dir, uint8_t sgb, int tileset) {

    uint8_t *bp_data = calloc(0x2000, 1);
    int bp_len = 0;
    uint8_t *lay_data = calloc(0x20000, 1);
    uint8_t *col_data = calloc(0x20000, 1);
    uint8_t *pal_data = calloc(0x200, 1);
    uint8_t *rgb = calloc(384, 1);
    uint8_t *bitplane = calloc(0x4000000, 1);
    uint8_t *raw_data = calloc(0x4000, 1);
    int rawlen = 0;
    int t_width, t_height;
    char name[255];
    
    struct dkl2_arches arch[] = {
        //  3A35 ROM,  HL/SP, A      2FB8 DBD0, ROM & H
        { {0x12, 0x4A, 0xE8, 0xDB}, {0x3D, 0x11, 0x03}, 114, {0xFF, 0x3A, 0xB8, 0x11, 0xF0, 0x08, 0x00, 0x00} }, // Ship Deck
        { {0x12, 0x40, 0x02, 0xE0}, {0xAE, 0x11, 0x02},  72, {0x53, 0x7F, 0x10, 0x42, 0xCE, 0x10, 0x00, 0x00} }, // Ship Mast
        { {0x14, 0x55, 0x12, 0xE0}, {0xA2, 0x11, 0x00},  86, {0x4F, 0x7F, 0x0D, 0x42, 0xCC, 0x00, 0x00, 0x00} }, // Ship Hold
        { {0x13, 0x60, 0xB8, 0xDD}, {0x70, 0x11, 0x01}, 114, {0x5F, 0x33, 0x7E, 0x02, 0x92, 0x10, 0x00, 0x00} }, // Lava
        { {0x12, 0x54, 0x4A, 0xCA}, {0x67, 0x11, 0x00},  59, {0x76, 0x22, 0x71, 0x01, 0xAC, 0x00, 0x00, 0x00} }, // Mine
        { {0x13, 0x6A, 0x2C, 0xE2}, {0xAF, 0x11, 0x03},  69, {0x9A, 0x03, 0x50, 0x02, 0x0B, 0x01, 0x00, 0x00} }, // Swamp
        { {0x14, 0x4A, 0xBD, 0xE1}, {0x00, 0x11, 0x01}, 112, {0x5F, 0x03, 0x19, 0x02, 0xF3, 0x00, 0x00, 0x00} }, // Hive
        { {0x13, 0x55, 0xA1, 0xE2}, {0x57, 0x11, 0x02},  87, {0xBF, 0x5B, 0x58, 0x32, 0xAD, 0x00, 0x00, 0x00} }, // Fair
        { {0x13, 0x40, 0x02, 0xE0}, {0x00, 0x14, 0x02},  51, {0x76, 0x22, 0x48, 0x02, 0x64, 0x01, 0x00, 0x00} }, // Brambles
        { {0x12, 0x5E, 0x6B, 0xDF}, {0x00, 0x11, 0x00}, 102, {0x76, 0x22, 0x90, 0x01, 0xAE, 0x00, 0x00, 0x00} }, // Forest
        { {0x13, 0x4B, 0x68, 0xE0}, {0x00, 0x11, 0x03},  61, {0x7B, 0x77, 0xF1, 0x72, 0x80, 0x65, 0x00, 0x00} }, // Ice
        { {0x14, 0x40, 0x02, 0xE1}, {0x32, 0x14, 0x02},  51, {0x78, 0x7F, 0x31, 0x4A, 0x10, 0x01, 0x00, 0x00} }, // Castle
        { {0x12, 0x68, 0xAE, 0xCE}, {0x00, 0x11, 0x02},  85, {0x58, 0x03, 0x91, 0x02, 0x8C, 0x01, 0x00, 0x00} }, // Jungle
    };
    
    struct dkl2_levels dkl[] = {
    //  31FF-A     3250 ROM & BC       31C7 ROM & BC       3B95 ROM & DE       PALETTE
        
        {0xBD, 0x00, {0x56, 0x90}, {0x4A, 0xF9}, {0x16, 0x53, 0x4F}, "1-1 Pirate Panic"},
        {0x09, 0x00, {0x41, 0xF2}, {0x57, 0x6E}, {0x17, 0x41, 0xC0}, "1-1 Pirate Panic B1"},
        {0x14, 0x00, {0x42, 0x63}, {0x57, 0x6E}, {0x17, 0x41, 0xFB}, "1-1 Pirate Panic B2"},
        {0x1E, 0x01, {0x4C, 0xCD}, {0x4A, 0x18}, {0x16, 0x48, 0xDA}, "1-2 Mainbrace Mayhem"},
        {0x08, 0x01, {0x40, 0x2A}, {0x57, 0x32}, {0x17, 0x40, 0x02}, "1-2 Mainbrace Mayhem B1"},
        {0x10, 0x01, {0x40, 0xA0}, {0x57, 0x32}, {0x17, 0x40, 0x30}, "1-2 Mainbrace Mayhem B2"},
        {0xE3, 0x00, {0x5A, 0x69}, {0x4A, 0xF9}, {0x16, 0x56, 0xEE}, "1-3 Gangplank Galley"},
        {0x09, 0x00, {0x41, 0xF2}, {0x57, 0x6E}, {0x17, 0x41, 0xC0}, "1-3 Gangplank Galley B1"},
        {0x21, 0x00, {0x42, 0xB9}, {0x57, 0x6E}, {0x17, 0x42, 0x66}, "1-3 Gangplank Galley B2"},
        {0x4C, 0x02, {0x63, 0x44}, {0x56, 0x4E}, {0x16, 0x5A, 0xED}, "1-4 Lockjaw's Locker"},
        {0x08, 0x02, {0x57, 0xF4}, {0x59, 0xB7}, {0x17, 0x57, 0xC9}, "1-4 Lockjaw's Locker B1"},
        {0x1E, 0x01, {0x51, 0xFE}, {0x4A, 0x18}, {0x16, 0x4D, 0x73}, "1-5 Topsail Trouble"},
        {0x08, 0x01, {0x40, 0x2A}, {0x57, 0x32}, {0x17, 0x40, 0x02}, "1-5 Topsail Trouble B1"},
        {0x0F, 0x01, {0x41, 0x37}, {0x57, 0x32}, {0x17, 0x40, 0xB5}, "1-5 Topsail Trouble B2"},
        {0x06, 0x01, {0x52, 0xB7}, {0x4A, 0x18}, {0x16, 0x52, 0x9C}, "1-B Krow's Nest"}, // 15
        
        {0xFB, 0x03, {0x77, 0xF3}, {0x51, 0x56}, {0x16, 0x74, 0x13}, "2-1 Hothead Hop"},
        {0x12, 0x03, {0x48, 0x91}, {0x58, 0x55}, {0x17, 0x48, 0x2F}, "2-1 Hothead Hop B1"},
        {0x1A, 0x03, {0x49, 0x10}, {0x58, 0x55}, {0x17, 0x48, 0x96}, "2-1 Hothead Hop B2"},
        {0x0F, 0x04, {0x6F, 0x3D}, {0x4C, 0xEE}, {0x16, 0x6C, 0x38}, "2-2 Kannon's Klaim"},
        {0x0C, 0x04, {0x46, 0x9F}, {0x58, 0x22}, {0x17, 0x46, 0x11}, "2-2 Kannon's Klaim B1"},
        {0x93, 0x02, {0x6B, 0x99}, {0x56, 0x4E}, {0x16, 0x63, 0xF8}, "2-3 Lava Lagoon"},
        {0x15, 0x02, {0x59, 0x02}, {0x59, 0xB7}, {0x17, 0x57, 0xF9}, "2-3 Lava Lagoon B1"},
        {0x1A, 0x02, {0x59, 0xC4}, {0x59, 0xB7}, {0x17, 0x59, 0x17}, "2-3 Lava Lagoon B2"},
        {0xE2, 0x03, {0x7B, 0x90}, {0x51, 0x56}, {0x16, 0x78, 0x54}, "2-4 Redhot Ride"},
        {0x13, 0x03, {0x49, 0x71}, {0x58, 0x55}, {0x17, 0x49, 0x17}, "2-4 Redhot Ride B1"},
        {0x13, 0x04, {0x73, 0x80}, {0x4C, 0xEE}, {0x16, 0x6F, 0xA5}, "2-5 Squawks's Shaft"},
        {0x0C, 0x04, {0x47, 0x34}, {0x58, 0x22}, {0x17, 0x46, 0xAB}, "2-5 Squawks's Shaft B1"},
        {0x09, 0x04, {0x47, 0xBF}, {0x58, 0x22}, {0x17, 0x47, 0x41}, "2-5 Squawks's Shaft B2"},
        {0xF5, 0x05, {0x63, 0x6A}, {0x52, 0xA0}, {0x17, 0x5F, 0xC8}, "2-6 Barrel Bayou"},
        {0x0A, 0x05, {0x4D, 0x3C}, {0x58, 0xAC}, {0x17, 0x4D, 0x04}, "2-6 Barrel Bayou B1"},
        {0x10, 0x05, {0x4D, 0x9B}, {0x58, 0xAC}, {0x17, 0x4D, 0x43}, "2-6 Barrel Bayou B2"},
        {0x55, 0x02, {0x6C, 0x3F}, {0x56, 0x4E}, {0x18, 0x61, 0x58}, "2-7 Glimmer's Galleon"},
        {0x0C, 0x02, {0x5A, 0x5E}, {0x59, 0xB7}, {0x17, 0x59, 0xCC}, "2-7 Glimmer's Galleon B1"},
        {0x15, 0x02, {0x5B, 0x98}, {0x59, 0xB7}, {0x17, 0x5A, 0x89}, "2-7 Glimmer's Galleon B2"},
        {0xDE, 0x05, {0x5B, 0xF0}, {0x52, 0xA0}, {0x18, 0x57, 0xDB}, "2-8 Krochead Klamber"},
        {0x1C, 0x05, {0x4E, 0x3B}, {0x58, 0xAC}, {0x17, 0x4D, 0xA5}, "2-8 Krochead Klamber B1"},
        {0xE4, 0x00, {0x4A, 0x64}, {0x4A, 0xF9}, {0x18, 0x46, 0x6E}, "2-9 Rattle Battle"},
        {0x10, 0x00, {0x43, 0x34}, {0x57, 0x6E}, {0x17, 0x42, 0xC2}, "2-9 Rattle Battle B1"},
        {0x1E, 0x01, {0x45, 0x86}, {0x4A, 0x18}, {0x18, 0x40, 0x02}, "2-A Slime Climb"},
        {0x15, 0x01, {0x41, 0xB9}, {0x57, 0x32}, {0x17, 0x41, 0x43}, "2-A Slime Climb B1"},
        {0x1B, 0x03, {0x53, 0x46}, {0x51, 0x56}, {0x16, 0x52, 0xBA}, "2-B Kleaver's Kiln"}, // 26
        
        {0x4C, 0x06, {0x4F, 0xFA}, {0x54, 0xD4}, {0x18, 0x4A, 0xDD}, "3-1 Hornet Hole"},
        {0x11, 0x06, {0x51, 0xFC}, {0x59, 0x36}, {0x17, 0x51, 0x93}, "3-1 Hornet Hole B1"},
        {0xFF, 0x07, {0x44, 0x14}, {0x50, 0x7B}, {0x16, 0x40, 0x03}, "3-2 Target Terror"},
        {0x36, 0x07, {0x54, 0xED}, {0x59, 0x6C}, {0x17, 0x53, 0xE8}, "3-2 Target Terror B1"},
        {0x2B, 0x07, {0x56, 0xA6}, {0x59, 0x6C}, {0x17, 0x55, 0xE9}, "3-2 Target Terror B2"},
        {0x4F, 0x08, {0x73, 0x73}, {0x4E, 0xEC}, {0x18, 0x6D, 0x35}, "3-3 Bramble Blast"},
        {0x11, 0x08, {0x4A, 0xE7}, {0x58, 0x85}, {0x17, 0x4A, 0x20}, "3-3 Bramble Blast B1"},
        {0x15, 0x08, {0x4B, 0x85}, {0x58, 0x85}, {0x17, 0x4A, 0xF5}, "3-3 Bramble Blast B2"},
        {0xFF, 0x07, {0x48, 0x7F}, {0x50, 0x7B}, {0x16, 0x44, 0x86}, "3-4 Rickety Race"},
        {0x46, 0x08, {0x7B, 0x91}, {0x4E, 0xEC}, {0x18, 0x74, 0x60}, "3-5 Bramble Scramble"},
        {0x15, 0x08, {0x4C, 0x27}, {0x58, 0x85}, {0x17, 0x4B, 0x90}, "3-5 Bramble Scramble B1"},
        {0xFE, 0x05, {0x60, 0xD8}, {0x52, 0xA0}, {0x18, 0x5C, 0x6A}, "3-6 Mudhole Marsh"},
        {0x19, 0x05, {0x4E, 0xC9}, {0x58, 0xAC}, {0x17, 0x4E, 0x4A}, "3-6 Mudhole Marsh B1"},
        {0x25, 0x05, {0x4F, 0x93}, {0x58, 0xAC}, {0x17, 0x4E, 0xD1}, "3-6 Mudhole Marsh B2"},
        {0x46, 0x06, {0x56, 0xE5}, {0x54, 0xD4}, {0x18, 0x50, 0xAF}, "3-7 Rambi Rumble"},
        {0x13, 0x06, {0x52, 0x62}, {0x59, 0x36}, {0x17, 0x52, 0x01}, "3-7 Rambi Rumble B1"},
        {0x29, 0x06, {0x52, 0xE8}, {0x59, 0x36}, {0x17, 0x52, 0x6D}, "3-7 Rambi Rumble B2"},
        {0x0C, 0x06, {0x5F, 0xC4}, {0x54, 0xD4}, {0x17, 0x5F, 0x82}, "3-B King Zing Sting"}, // 18
        
        {0xFF, 0x09, {0x44, 0x78}, {0x4E, 0x02}, {0x19, 0x40, 0x02}, "4-1 Ghostly Grove"},
        {0x1D, 0x09, {0x50, 0x4E}, {0x59, 0x06}, {0x17, 0x4F, 0xB3}, "4-1 Ghostly Grove B1"},
        {0xFF, 0x07, {0x53, 0x83}, {0x50, 0x7B}, {0x19, 0x4E, 0xC9}, "4-2 Krazy Koaster"},
        {0x38, 0x07, {0x57, 0xA4}, {0x59, 0x6C}, {0x17, 0x56, 0xB3}, "4-2 Krazy Koaster B1"},
        {0xFF, 0x09, {0x49, 0x93}, {0x4E, 0x02}, {0x19, 0x45, 0x2C}, "4-3 Gusty Glade"},
        {0x15, 0x09, {0x50, 0xBE}, {0x59, 0x06}, {0x17, 0x50, 0x68}, "4-3 Gusty Glade B1"},
        {0x18, 0x09, {0x51, 0x32}, {0x59, 0x06}, {0x17, 0x50, 0xCD}, "4-3 Gusty Glade B2"},
        {0x13, 0x06, {0x59, 0x11}, {0x54, 0xD4}, {0x19, 0x53, 0xD9}, "4-4 Parrot Chute Panic"},
        {0x0F, 0x06, {0x53, 0x57}, {0x59, 0x36}, {0x17, 0x52, 0xF5}, "4-4 Parrot Chute Panic B1"},
        {0x12, 0x06, {0x53, 0xDA}, {0x59, 0x36}, {0x17, 0x53, 0x61}, "4-4 Parrot Chute Panic B2"},
        {0xFF, 0x09, {0x4E, 0x51}, {0x4E, 0x02}, {0x19, 0x49, 0xEF}, "4-5 Web Woods"},
        {0x14, 0x09, {0x51, 0x8D}, {0x59, 0x06}, {0x17, 0x51, 0x3A}, "4-5 Web Woods B1"},
        {0x06, 0x01, {0x64, 0x22}, {0x4A, 0x18}, {0x17, 0x63, 0xE2}, "4-B Kreepy Krow"}, // 13
        
        {0x47, 0x0A, {0x60, 0x0F}, {0x4B, 0xE0}, {0x19, 0x59, 0xD6}, "5-1 Arctic Abyss"},
        {0x0B, 0x0A, {0x43, 0xCF}, {0x57, 0xAA}, {0x17, 0x43, 0x4C}, "5-1 Arctic Abyss B1"},
        {0x11, 0x0A, {0x44, 0x72}, {0x57, 0xAA}, {0x17, 0x43, 0xD8}, "5-1 Arctic Abyss B2"},
        {0x0B, 0x04, {0x63, 0x66}, {0x4C, 0xEE}, {0x1A, 0x5F, 0xD6}, "5-2 Windy Well"},
        {0x14, 0x04, {0x48, 0x0E}, {0x58, 0x22}, {0x17, 0x47, 0xC7}, "5-2 Windy Well B1"},
        {0x20, 0x0B, {0x6C, 0x10}, {0x53, 0xF0}, {0x19, 0x65, 0xF4}, "5-3 Dungeon Danger"},
        {0x12, 0x0B, {0x5D, 0x45}, {0x57, 0xFE}, {0x17, 0x5C, 0xDD}, "5-3 Dungeon Danger B1"},
        {0x12, 0x0B, {0x5D, 0xA5}, {0x57, 0xFE}, {0x17, 0x5D, 0x4B}, "5-3 Dungeon Danger B2"},
        {0xFC, 0x0A, {0x65, 0x6D}, {0x4B, 0xE0}, {0x19, 0x60, 0xA9}, "5-4 Clapper's Cavern"},
        {0x1D, 0x0A, {0x45, 0x2B}, {0x57, 0xAA}, {0x17, 0x44, 0x8D}, "5-4 Clapper's Cavern B1"},
        {0x10, 0x0B, {0x72, 0xA2}, {0x53, 0xF0}, {0x19, 0x6C, 0x6A}, "5-5 Chain Link Chamber"},
        {0x14, 0x0B, {0x5E, 0x35}, {0x57, 0xFE}, {0x17, 0x5D, 0xBA}, "5-5 Chain Link Chamber B1"},
        {0x19, 0x0B, {0x5E, 0xBA}, {0x57, 0xFE}, {0x17, 0x5E, 0x48}, "5-5 Chain Link Chamber B2"},
        {0x13, 0x0B, {0x7A, 0xE2}, {0x53, 0xF0}, {0x19, 0x73, 0x4F}, "5-6 Toxic Tower"},
        {0x15, 0x0B, {0x5F, 0x48}, {0x57, 0xFE}, {0x17, 0x5E, 0xC1}, "5-6 Toxic Tower B1"},
        {0x09, 0x0B, {0x7C, 0xCE}, {0x53, 0xF0}, {0x19, 0x7B, 0xAA}, "5-B Stronghold Showdown"}, // 16
        
        {0x5B, 0x08, {0x58, 0x45}, {0x4E, 0xEC}, {0x1A, 0x52, 0x05}, "6-1 Screech's Sprint"},
        {0x1A, 0x08, {0x4C, 0xFB}, {0x58, 0x85}, {0x17, 0x4C, 0x49}, "6-1 Screech's Sprint B1"},
        {0x08, 0x0B, {0x5F, 0x7F}, {0x53, 0xF0}, {0x17, 0x5F, 0x58}, "6-B K.Rool Duel"}, // 3
        
        {0xFF, 0x0C, {0x48, 0x9A}, {0x4F, 0xBE}, {0x1A, 0x44, 0xA1}, "7-1 Jungle Jinx"},
        {0x19, 0x0C, {0x5C, 0x00}, {0x57, 0xD7}, {0x17, 0x5B, 0xB2}, "7-1 Jungle Jinx B1"},
        {0x11, 0x0A, {0x5E, 0xFD}, {0x4B, 0xE0}, {0x1A, 0x59, 0x0F}, "7-2 Black Ice Battle"},
        {0x0D, 0x0A, {0x46, 0x04}, {0x57, 0xAA}, {0x17, 0x45, 0x33}, "7-2 Black Ice Battle B1"},
        {0xFF, 0x03, {0x44, 0x0F}, {0x51, 0x56}, {0x1A, 0x40, 0x03}, "7-3 Fiery Furnace"},
        {0x1D, 0x03, {0x4A, 0x11}, {0x58, 0x55}, {0x17, 0x49, 0x89}, "7-3 Fiery Furnace B1"},
        {0xFF, 0x0C, {0x4D, 0x0D}, {0x4F, 0xBE}, {0x1A, 0x49, 0x17}, "7-4 Klobber Karnage"},
        {0x14, 0x0C, {0x5C, 0x61}, {0x57, 0xD7}, {0x17, 0x5C, 0x0A}, "7-4 Klobber Karnage B1"},
        {0xE9, 0x0C, {0x51, 0x87}, {0x4F, 0xBE}, {0x1A, 0x4D, 0xBB}, "7-5 Animal Antics"},
        {0x16, 0x0C, {0x5C, 0xC2}, {0x57, 0xD7}, {0x17, 0x5C, 0x74}, "7-5 Animal Antics B1"},
        {0x08, 0x03, {0x5F, 0xD3}, {0x51, 0x56}, {0x1A, 0x5F, 0xAB}, "7-B Krocodile Kore"}, // 11
    };
    
    int a, i, bank;
    uint8_t bw[] = {0xBD, 0x77, 0x94, 0x52, 0xAD, 0x35, 0x42, 0x08}; // 16, 88, 160, 232
    
    
    int size = sizeof(dkl) / sizeof(struct dkl2_levels);
    
    for (i = 0; i < size; i++) {
    
        a = dkl[i].arch;
        rawlen = 0;
        bp_len = 0;
       
        memset(raw_data, 0, 0x4000);
        if (!tileset) {
            dkl_raw(rom, raw_data, &rawlen, dkl[i].raw[0], dkl[i].raw[1], dkl[i].raw[2]);
            dkl2_raw_fix(rom, raw_data, rawlen, (dkl[i].raw[0]*0x4000)+((dkl[i].rf1[0]-0x40)*256)+dkl[i].rf1[1], (0x10 * 0x4000)+((dkl[i].rf2[0]-0x40)*256)+dkl[i].rf2[1]);
            t_width  = dkl[i].t_width;
            t_height = rawlen / dkl[i].t_width;
        }
        else {
            tile_generator(raw_data, &rawlen, arch[a].tiles, 0);
            t_width = 16;
            t_height = (rawlen / t_width);
            if (rawlen % t_width) t_height++;
        }
        
        // Decompress Bitplane data
        dkl2_tiles(rom, bp_data, &bp_len, arch[a].bp_bank[0], ((arch[a].bp_bank[1]-0x40)*256)+arch[a].bp_bank[2], arch[a].bp_bank[3]);
        
        bank = ((arch[a].lay[1] * 0x4000) + (arch[a].lay[2] * 0x1000));
        
        // Decode layout (raw is stored uncompressed in ROM)
        dkl_layout(rom, raw_data, lay_data, arch[a].lay[0], bank, t_width, t_height);
        
        if (sgb == 5) {
            decode_palette(rgb, &bw[0], 4);
        }
        else {
            decode_palette(rgb, &arch[a].pal[0], 4);
        }
        
        gbc_assemble(bitplane, bp_data, lay_data, col_data, rgb, t_width, t_height, 0);
        
        strcpy(name, dkl[i].name);
        if (tileset) strcat(name, " Tiles");
        strcat(name, ".png");
        arrange_gbc(bitplane, (t_width*32), (t_height*32), dir, name);
        
    }
    
    free(rom);
    free(bp_data);
    free(lay_data);
    free(raw_data);
    free(col_data);
    free(pal_data);
    free(rgb);
    free(bitplane);
    

} // dkl2_levels();

void dkl3_levels(uint8_t *rom, char *dir, uint8_t sgb, int tileset) {

    uint8_t *bp_data = calloc(0x2000, 1);
    int bp_len = 0;
    
    uint8_t *lay_data = calloc(0x20000, 1);
    uint8_t *col_data = calloc(0x20000, 1);
    uint8_t *pal_data = calloc(0x200, 1);
    uint8_t *rgb = calloc(384, 1);
    uint8_t *bitplane = calloc(0x4000000, 1);
    uint8_t *raw_data = calloc(0x4000, 1);
    int rawlen = 0;
    int t_width, t_height;
    char name[255];
    
    struct dkl3_arches arch[] = {
        //  3A67 ROM,  HL/SP, A      3020 DBD0, ROM & H, TILES
        { {0x12, 0x5C, 0xB1, 0xE0}, {0x00, 0x11, 0x00}, 128}, // Boardwalk
        { {0x12, 0x66, 0x73, 0xE2}, {0x5F, 0x15, 0x00},  50}, // Underwater
        { {0x12, 0x40, 0x02, 0xB1}, {0x00, 0x11, 0x03}, 109}, // Mill
        { {0x13, 0x61, 0xAA, 0xDA}, {0x00, 0x11, 0x01}, 106}, // Riverside
        { {0x13, 0x6C, 0x8C, 0xDD}, {0x7F, 0x11, 0x00},  99}, // Tree
        { {0x12, 0x47, 0x96, 0xE0}, {0x6D, 0x11, 0x03},  95}, // Snow
        { {0x13, 0x40, 0x02, 0xD7}, {0x00, 0x11, 0x02},  76}, // Waterfall
        { {0x13, 0x4B, 0xDF, 0xE0}, {0x4C, 0x11, 0x02},  79}, // Cliff
        { {0x12, 0x72, 0x51, 0xDA}, {0x6A, 0x11, 0x01},  68}, // Jungle
        { {0x13, 0x57, 0x88, 0xDB}, {0x00, 0x15, 0x00},  95}, // Le Factoire
        { {0x13, 0x77, 0x46, 0xE0}, {0x91, 0x15, 0x00}, 106}, // Pipe
        { {0x12, 0x51, 0x5A, 0xDE}, {0x9B, 0x11, 0x02},  71}, // Cave
    }; // 
    
    struct dkl3_levels dkl[] = {
    //   327C-A     32CD ROM & BC  3244 BC          3BC7 ROM & DE       PALETTE
        {0x97, 0x00, {0x43, 0xA0}, {0x4F, 0x5A}, {0x17, 0x40, 0x03}, {0x16, 0x7F, 0xD0, 0x45, 0x8A, 0x08, 0x00, 0x00}, "1-1 Red Wharf"},
        {0x19, 0x00, {0x54, 0xE5}, {0x5B, 0x33}, {0x18, 0x54, 0x47}, {0x16, 0x7F, 0xD0, 0x45, 0x8A, 0x08, 0x00, 0x00}, "1-1 Red Wharf B1"},
        {0x0F, 0x00, {0x55, 0x6B}, {0x5B, 0x33}, {0x18, 0x54, 0xEF}, {0x16, 0x7F, 0xD0, 0x45, 0x8A, 0x08, 0x00, 0x00}, "1-1 Red Wharf B2"},
        {0x0E, 0x00, {0x62, 0x06}, {0x5B, 0x33}, {0x18, 0x61, 0xCE}, {0x16, 0x7F, 0xD0, 0x45, 0x8A, 0x08, 0x00, 0x00}, "1-1 Red Wharf Warp"},
        {0x47, 0x01, {0x4B, 0x60}, {0x4B, 0xF1}, {0x16, 0x40, 0x03}, {0xFD, 0x7E, 0xF6, 0x59, 0x0F, 0x35, 0x00, 0x00}, "1-2 Seabed Shanty"},
        {0x15, 0x01, {0x45, 0x46}, {0x5A, 0x22}, {0x18, 0x44, 0x6F}, {0xFD, 0x7E, 0xF6, 0x59, 0x0F, 0x35, 0x00, 0x00}, "1-2 Seabed Shanty B1"},
        {0x18, 0x01, {0x46, 0x47}, {0x5A, 0x22}, {0x18, 0x45, 0x4F}, {0xFD, 0x7E, 0xF6, 0x59, 0x0F, 0x35, 0x00, 0x00}, "1-2 Seabed Shanty B2"},
        {0x15, 0x01, {0x61, 0x18}, {0x5A, 0x22}, {0x18, 0x60, 0xB7}, {0xFD, 0x7E, 0xF6, 0x59, 0x0F, 0x35, 0x00, 0x00}, "1-2 Seabed Shanty Warp"},
        {0xBF, 0x00, {0x49, 0x12}, {0x4F, 0x5A}, {0x17, 0x43, 0xE2}, {0x1B, 0x57, 0xD2, 0x2D, 0x8A, 0x08, 0x00, 0x00}, "1-3 Ford Knocks"},
        {0x19, 0x00, {0x56, 0x0D}, {0x5B, 0x33}, {0x18, 0x55, 0x75}, {0x1B, 0x57, 0xD2, 0x2D, 0x8A, 0x08, 0x00, 0x00}, "1-3 Ford Knocks B1"},
        {0x14, 0x00, {0x56, 0x55}, {0x5B, 0x33}, {0x18, 0x56, 0x15}, {0x1B, 0x57, 0xD2, 0x2D, 0x8A, 0x08, 0x00, 0x00}, "1-3 Ford Knocks B2"},
        {0x0B, 0x00, {0x62, 0x5B}, {0x5B, 0x33}, {0x18, 0x62, 0x0C}, {0x1B, 0x57, 0xD2, 0x2D, 0x8A, 0x08, 0x00, 0x00}, "1-3 Ford Knocks Warp"},
        {0x38, 0x02, {0x68, 0x24}, {0x4C, 0xF9}, {0x16, 0x64, 0x59}, {0x3F, 0x03, 0x17, 0x02, 0x0E, 0x01, 0x00, 0x00}, "1-3 Total Rekoil"},
        {0x17, 0x02, {0x49, 0x67}, {0x5A, 0x82}, {0x18, 0x49, 0x17}, {0x3F, 0x03, 0x17, 0x02, 0x0E, 0x01, 0x00, 0x00}, "1-3 Total Rekoil B1"},
        {0x16, 0x02, {0x49, 0xD7}, {0x5A, 0x82}, {0x18, 0x49, 0x6F}, {0x3F, 0x03, 0x17, 0x02, 0x0E, 0x01, 0x00, 0x00}, "1-3 Total Rekoil B2"},
        {0x10, 0x02, {0x61, 0x5C}, {0x5A, 0x82}, {0x18, 0x61, 0x23}, {0x3F, 0x03, 0x17, 0x02, 0x0E, 0x01, 0x00, 0x00}, "1-3 Total Rekoil Warp"},
        {0xA2, 0x03, {0x65, 0xA5}, {0x4E, 0x37}, {0x1A, 0x62, 0x61}, {0x79, 0x26, 0xAC, 0x15, 0x00, 0x01, 0x00, 0x00}, "1-4 Koco Channel"},
        {0x29, 0x03, {0x4C, 0xF6}, {0x5A, 0xDC}, {0x18, 0x4C, 0x45}, {0x79, 0x26, 0xAC, 0x15, 0x00, 0x01, 0x00, 0x00}, "1-4 Koco Channel B1"},
        {0x1E, 0x03, {0x4D, 0xD3}, {0x5A, 0xDC}, {0x18, 0x4D, 0x06}, {0x79, 0x26, 0xAC, 0x15, 0x00, 0x01, 0x00, 0x00}, "1-4 Koco Channel B2"},
        {0x0C, 0x03, {0x61, 0xCA}, {0x5A, 0xDC}, {0x18, 0x61, 0xAF}, {0x79, 0x26, 0xAC, 0x15, 0x00, 0x01, 0x00, 0x00}, "1-4 Koco Channel Warp"},
        {0x4A, 0x02, {0x6E, 0x0E}, {0x4C, 0xF9}, {0x16, 0x68, 0x90}, {0x36, 0x16, 0x91, 0x0D, 0xEB, 0x00, 0x00, 0x00}, "1-5 Liftshaft Lottery"},
        {0x12, 0x02, {0x4A, 0x5D}, {0x5A, 0x82}, {0x18, 0x49, 0xE3}, {0x36, 0x16, 0x91, 0x0D, 0xEB, 0x00, 0x00, 0x00}, "1-5 Liftshaft Lottery B1"},
        {0x18, 0x02, {0x4B, 0x21}, {0x5A, 0x82}, {0x18, 0x4A, 0x70}, {0x36, 0x16, 0x91, 0x0D, 0xEB, 0x00, 0x00, 0x00}, "1-5 Liftshaft Lottery B2"},
        {0x15, 0x02, {0x61, 0xA7}, {0x5A, 0x82}, {0x18, 0x61, 0x61}, {0x36, 0x16, 0x91, 0x0D, 0xEB, 0x00, 0x00, 0x00}, "1-5 Liftshaft Lottery Warp"},
        {0x09, 0x01, {0x64, 0x55}, {0x4B, 0xF1}, {0x16, 0x64, 0x25}, {0xDA, 0x7F, 0xD1, 0x5A, 0xC9, 0x35, 0x00, 0x00}, "1-B Barbos Bastion"},
    
        {0x44, 0x01, {0x57, 0x04}, {0x4B, 0xF1}, {0x16, 0x4C, 0x04}, {0x9F, 0x7E, 0x58, 0x51, 0x11, 0x20, 0x00, 0x00}, "2-1 Coral Quarrel"},
        {0x21, 0x01, {0x46, 0xDF}, {0x5A, 0x22}, {0x18, 0x46, 0x58}, {0x9F, 0x7E, 0x58, 0x51, 0x11, 0x20, 0x00, 0x00}, "2-1 Coral Quarrel B1"},
        {0x16, 0x01, {0x47, 0x9A}, {0x5A, 0x22}, {0x18, 0x46, 0xEE}, {0x9F, 0x7E, 0x58, 0x51, 0x11, 0x20, 0x00, 0x00}, "2-1 Coral Quarrel B2"},
        {0x4E, 0x04, {0x64, 0x10}, {0x51, 0xDF}, {0x17, 0x5E, 0x58}, {0xD9, 0x2E, 0xEF, 0x15, 0x24, 0x01, 0x00, 0x00}, "2-2 Minky Mischief"},
        {0x0D, 0x04, {0x58, 0xCB}, {0x5B, 0xE4}, {0x18, 0x58, 0x24}, {0xD9, 0x2E, 0xEF, 0x15, 0x24, 0x01, 0x00, 0x00}, "2-2 Minky Mischief B1"},
        {0x19, 0x04, {0x59, 0xAC}, {0x5B, 0xE4}, {0x18, 0x58, 0xD8}, {0xD9, 0x2E, 0xEF, 0x15, 0x24, 0x01, 0x00, 0x00}, "2-2 Minky Mischief B2"},
        {0xD0, 0x00, {0x4E, 0x12}, {0x4F, 0x5A}, {0x17, 0x49, 0x77}, {0xDF, 0x36, 0xB4, 0x21, 0x8B, 0x08, 0x00, 0x00}, "2-3 Jetty Jitters"},
        {0x21, 0x00, {0x58, 0x13}, {0x5B, 0x33}, {0x18, 0x57, 0x31}, {0xDF, 0x36, 0xB4, 0x21, 0x8B, 0x08, 0x00, 0x00}, "2-3 Jetty Jitters B1"},
        {0x22, 0x00, {0x57, 0x21}, {0x5B, 0x33}, {0x18, 0x56, 0x5C}, {0xDF, 0x36, 0xB4, 0x21, 0x8B, 0x08, 0x00, 0x00}, "2-3 Jetty Jitters B2"},
        {0xEE, 0x05, {0x54, 0x08}, {0x50, 0xB6}, {0x17, 0x4E, 0x72}, {0xF7, 0x6F, 0x8C, 0x46, 0x00, 0x21, 0x00, 0x00}, "2-4 Black Ice Blitz"},
        {0x2B, 0x05, {0x53, 0xA6}, {0x5B, 0x96}, {0x18, 0x52, 0xE0}, {0xF7, 0x6F, 0x8C, 0x46, 0x00, 0x21, 0x00, 0x00}, "2-4 Black Ice Blitz B1"},
        {0x16, 0x05, {0x54, 0x3C}, {0x5B, 0x96}, {0x18, 0x53, 0xB4}, {0xF7, 0x6F, 0x8C, 0x46, 0x00, 0x21, 0x00, 0x00}, "2-4 Black Ice Blitz B2"},
        {0xCC, 0x03, {0x7F, 0x61}, {0x4E, 0x37}, {0x16, 0x7B, 0x0F}, {0xD3, 0x2A, 0xE6, 0x19, 0x00, 0x0D, 0x00, 0x00}, "2-5 Riverbank Riot"},
        {0x20, 0x03, {0x4E, 0x66}, {0x5A, 0xDC}, {0x18, 0x4D, 0xE0}, {0xD3, 0x2A, 0xE6, 0x19, 0x00, 0x0D, 0x00, 0x00}, "2-5 Riverbank Riot B1"},
        {0x13, 0x03, {0x4E, 0xF0}, {0x5A, 0xDC}, {0x18, 0x4E, 0x72}, {0xD3, 0x2A, 0xE6, 0x19, 0x00, 0x0D, 0x00, 0x00}, "2-5 Riverbank Riot B2"},
        {0x1E, 0x02, {0x72, 0xBD}, {0x4C, 0xF9}, {0x16, 0x6E, 0x95}, {0x36, 0x36, 0x91, 0x21, 0xEB, 0x10, 0x00, 0x00}, "2-6 Miller Instinct"},
        {0x1B, 0x02, {0x4B, 0xEA}, {0x5A, 0x82}, {0x18, 0x4B, 0x31}, {0x36, 0x36, 0x91, 0x21, 0xEB, 0x10, 0x00, 0x00}, "2-6 Miller Instinct B1"},
        {0x0F, 0x02, {0x4C, 0x37}, {0x5A, 0x82}, {0x18, 0x4B, 0xFB}, {0x36, 0x36, 0x91, 0x21, 0xEB, 0x10, 0x00, 0x00}, "2-6 Miller Instinct B2"},
        {0x07, 0x05, {0x7D, 0xCE}, {0x50, 0xB6}, {0x1A, 0x7D, 0x9F}, {0xDA, 0x7F, 0xD1, 0x5A, 0xC9, 0x35, 0x00, 0x00}, "2-B Bleak Magic"},
    
        {0x1A, 0x06, {0x43, 0xCB}, {0x54, 0x2B}, {0x18, 0x40, 0x03}, {0xF8, 0x7F, 0xA6, 0x56, 0x60, 0x29, 0x00, 0x00}, "3-1 Rocketeer Rally"},
        {0x0E, 0x06, {0x6D, 0x66}, {0x5C, 0x95}, {0x18, 0x6C, 0xF5}, {0xF8, 0x7F, 0xA6, 0x56, 0x60, 0x29, 0x00, 0x00}, "3-1 Rocketeer Rally B1"},
        {0x0C, 0x06, {0x6D, 0xD0}, {0x5C, 0x95}, {0x18, 0x6D, 0x79}, {0xF8, 0x7F, 0xA6, 0x56, 0x60, 0x29, 0x00, 0x00}, "3-1 Rocketeer Rally B2"},
        {0x26, 0x07, {0x51, 0xEA}, {0x53, 0x5C}, {0x1A, 0x4D, 0x3A}, {0x3C, 0x67, 0x4C, 0x41, 0x08, 0x21, 0x00, 0x00}, "3-2 Vertigo Verge"},
        {0x0E, 0x07, {0x5D, 0x81}, {0x5C, 0x5C}, {0x18, 0x5D, 0x3E}, {0x3C, 0x67, 0x4C, 0x41, 0x08, 0x21, 0x00, 0x00}, "3-2 Vertigo Verge B1"},
        {0x14, 0x07, {0x5E, 0x36}, {0x5C, 0x5C}, {0x18, 0x5D, 0x8E}, {0x3C, 0x67, 0x4C, 0x41, 0x08, 0x21, 0x00, 0x00}, "3-2 Vertigo Verge B2"},
        {0xD5, 0x05, {0x59, 0xB0}, {0x50, 0xB6}, {0x17, 0x54, 0x59}, {0x57, 0x6F, 0xEC, 0x49, 0xA0, 0x24, 0x00, 0x00}, "3-3 Polar Pitfalls"},
        {0x1D, 0x05, {0x50, 0xB0}, {0x5B, 0x96}, {0x18, 0x50, 0x12}, {0x57, 0x6F, 0xEC, 0x49, 0xA0, 0x24, 0x00, 0x00}, "3-3 Polar Pitfalls B1"},
        {0x1E, 0x05, {0x51, 0x7E}, {0x5B, 0x96}, {0x18, 0x50, 0xBA}, {0x57, 0x6F, 0xEC, 0x49, 0xA0, 0x24, 0x00, 0x00}, "3-3 Polar Pitfalls B2"},
        {0xC9, 0x03, {0x61, 0xFA}, {0x4E, 0x37}, {0x1A, 0x5E, 0xDD}, {0x0E, 0x33, 0x2C, 0x1A, 0x29, 0x01, 0x00, 0x00}, "3-4 Surface Tension"},
        {0x17, 0x03, {0x4F, 0x58}, {0x5A, 0xDC}, {0x18, 0x4E, 0xFE}, {0x0E, 0x33, 0x2C, 0x1A, 0x29, 0x01, 0x00, 0x00}, "3-4 Surface Tension B1"},
        {0x1C, 0x03, {0x50, 0x07}, {0x5A, 0xDC}, {0x18, 0x4F, 0x65}, {0x0E, 0x33, 0x2C, 0x1A, 0x29, 0x01, 0x00, 0x00}, "3-4 Surface Tension B2"},
        {0xD7, 0x05, {0x5E, 0x17}, {0x50, 0xB6}, {0x17, 0x5A, 0x01}, {0xD7, 0x6E, 0xAF, 0x49, 0xA6, 0x24, 0x00, 0x00}, "3-5 Tundra Blunda"},
        {0x19, 0x05, {0x52, 0x10}, {0x5B, 0x96}, {0x18, 0x51, 0x85}, {0xD7, 0x6E, 0xAF, 0x49, 0xA6, 0x24, 0x00, 0x00}, "3-5 Tundra Blunda B1"},
        {0x24, 0x05, {0x52, 0xDA}, {0x5B, 0x96}, {0x18, 0x52, 0x19}, {0xD7, 0x6E, 0xAF, 0x49, 0xA6, 0x24, 0x00, 0x00}, "3-5 Tundra Blunda B2"},
        {0x37, 0x04, {0x68, 0xDE}, {0x51, 0xDF}, {0x17, 0x64, 0x89}, {0x79, 0x02, 0x52, 0x01, 0x2B, 0x00, 0x00, 0x00}, "3-6 Redwood Rampage"},
        {0x0E, 0x04, {0x5A, 0x79}, {0x5B, 0xE4}, {0x18, 0x59, 0xBE}, {0x79, 0x02, 0x52, 0x01, 0x2B, 0x00, 0x00, 0x00}, "3-6 Redwood Rampage B1"},
        {0x0E, 0x04, {0x5B, 0x4B}, {0x5B, 0xE4}, {0x18, 0x5A, 0x86}, {0x79, 0x02, 0x52, 0x01, 0x2B, 0x00, 0x00, 0x00}, "3-6 Redwood Rampage B2"},
        {0x08, 0x04, {0x69, 0x63}, {0x51, 0xDF}, {0x17, 0x69, 0x3B}, {0xBA, 0x7F, 0x2F, 0x4E, 0xA3, 0x1C, 0x00, 0x00}, "3-B Arich Attack"},
    
        {0xE9, 0x08, {0x6D, 0xA5}, {0x56, 0xCB}, {0x17, 0x69, 0x66}, {0xF5, 0x02, 0x0E, 0x02, 0xC7, 0x00, 0x00, 0x00}, "4-1 Jungle Jeopardy"},
        {0x1F, 0x08, {0x77, 0x3D}, {0x5D, 0x55}, {0x17, 0x76, 0xA6}, {0xF5, 0x02, 0x0E, 0x02, 0xC7, 0x00, 0x00, 0x00}, "4-1 Jungle Jeopardy B1"},
        {0x23, 0x08, {0x77, 0xC8}, {0x5D, 0x55}, {0x17, 0x77, 0x49}, {0xF5, 0x02, 0x0E, 0x02, 0xC7, 0x00, 0x00, 0x00}, "4-1 Jungle Jeopardy B2"},
        {0x32, 0x06, {0x66, 0xD9}, {0x54, 0x2B}, {0x18, 0x62, 0x60}, {0xF8, 0x6F, 0x6C, 0x4E, 0xC0, 0x2C, 0x00, 0x00}, "4-2 Footloose Falls"},
        {0x12, 0x06, {0x6E, 0x58}, {0x5C, 0x95}, {0x18, 0x6D, 0xDF}, {0xF8, 0x6F, 0x6C, 0x4E, 0xC0, 0x2C, 0x00, 0x00}, "4-2 Footloose Falls B1"},
        {0x0A, 0x06, {0x6E, 0xAD}, {0x5C, 0x95}, {0x18, 0x6E, 0x64}, {0xF8, 0x6F, 0x6C, 0x4E, 0xC0, 0x2C, 0x00, 0x00}, "4-2 Footloose Falls B2"},
        {0x45, 0x01, {0x63, 0x77}, {0x4B, 0xF1}, {0x16, 0x57, 0x9E}, {0x9A, 0x7E, 0xCD, 0x55, 0x00, 0x29, 0x00, 0x00}, "4-3 Deep Reef Grief"},
        {0x13, 0x01, {0x48, 0x54}, {0x5A, 0x22}, {0x18, 0x47, 0xA4}, {0x9A, 0x7E, 0xCD, 0x55, 0x00, 0x29, 0x00, 0x00}, "4-3 Deep Reef Grief B1"},
        {0x13, 0x01, {0x49, 0x08}, {0x5A, 0x22}, {0x18, 0x48, 0x63}, {0x9A, 0x7E, 0xCD, 0x55, 0x00, 0x29, 0x00, 0x00}, "4-3 Deep Reef Grief B2"},
        {0x46, 0x09, {0x6A, 0xF4}, {0x57, 0xD0}, {0x1A, 0x65, 0xF9}, {0xFF, 0x27, 0x97, 0x1A, 0x0F, 0x11, 0x00, 0x00}, "4-4 Karbine KAOS"},
        {0x19, 0x09, {0x78, 0xC9}, {0x5D, 0xA9}, {0x1A, 0x78, 0x5D}, {0xFF, 0x27, 0x97, 0x1A, 0x0F, 0x11, 0x00, 0x00}, "4-4 Karbine KAOS B1"},
        {0x15, 0x09, {0x79, 0x33}, {0x5D, 0xA9}, {0x1A, 0x78, 0xD3}, {0xFF, 0x27, 0x97, 0x1A, 0x0F, 0x11, 0x00, 0x00}, "4-4 Karbine KAOS B2"},
        {0x41, 0x04, {0x73, 0x47}, {0x51, 0xDF}, {0x18, 0x6F, 0xA4}, {0x72, 0x02, 0x8C, 0x01, 0xA7, 0x00, 0x00, 0x00}, "4-5 Simian Shimmy"},
        {0x10, 0x04, {0x5C, 0x0E}, {0x5B, 0xE4}, {0x18, 0x5B, 0x5D}, {0x72, 0x02, 0x8C, 0x01, 0xA7, 0x00, 0x00, 0x00}, "4-5 Simian Shimmy B1"},
        {0x17, 0x04, {0x5D, 0x26}, {0x5B, 0xE4}, {0x18, 0x5C, 0x1B}, {0x72, 0x02, 0x8C, 0x01, 0xA7, 0x00, 0x00, 0x00}, "4-5 Simian Shimmy B2"},
        {0x43, 0x07, {0x57, 0xD4}, {0x53, 0x5C}, {0x1A, 0x52, 0x67}, {0x3C, 0x67, 0x14, 0x42, 0x0C, 0x21, 0x00, 0x00}, "4-6 Rockface Chase"},
        {0x2C, 0x07, {0x5F, 0x07}, {0x5C, 0x5C}, {0x18, 0x5E, 0x40}, {0x3C, 0x67, 0x14, 0x42, 0x0C, 0x21, 0x00, 0x00}, "4-6 Rockface Chase B1"},
        {0x14, 0x07, {0x5F, 0xB8}, {0x5C, 0x5C}, {0x18, 0x5F, 0x24}, {0x3C, 0x67, 0x14, 0x42, 0x0C, 0x21, 0x00, 0x00}, "4-6 Rockface Chase B2"},
        {0x09, 0x09, {0x7D, 0x9C}, {0x57, 0xD0}, {0x1A, 0x7D, 0x60}, {0xFF, 0x3A, 0xB8, 0x11, 0xF0, 0x08, 0x00, 0x00}, "4-B Krazy KAOS"},
    
        {0xEB, 0x08, {0x72, 0x2D}, {0x56, 0xCB}, {0x17, 0x6E, 0x06}, {0xF4, 0x02, 0x10, 0x02, 0x2B, 0x01, 0x00, 0x00}, "5-1 Tropical Tightropes"},
        {0x1C, 0x08, {0x78, 0x54}, {0x5D, 0x55}, {0x17, 0x77, 0xD2}, {0xF4, 0x02, 0x10, 0x02, 0x2B, 0x01, 0x00, 0x00}, "5-1 Tropical Tightropes B1"},
        {0x25, 0x08, {0x78, 0xD4}, {0x5D, 0x55}, {0x17, 0x78, 0x62}, {0xF4, 0x02, 0x10, 0x02, 0x2B, 0x01, 0x00, 0x00}, "5-1 Tropical Tightropes B2"},
        {0x21, 0x07, {0x5E, 0x40}, {0x53, 0x5C}, {0x1A, 0x58, 0x75}, {0x36, 0x6F, 0x11, 0x4E, 0x0C, 0x31, 0x00, 0x00}, "5-2 Clifftop Critters"},
        {0x0E, 0x07, {0x60, 0x1B}, {0x5C, 0x5C}, {0x18, 0x5F, 0xCA}, {0x36, 0x6F, 0x11, 0x4E, 0x0C, 0x31, 0x00, 0x00}, "5-2 Clifftop Critters B1"},
        {0x0D, 0x07, {0x60, 0xAD}, {0x5C, 0x5C}, {0x18, 0x60, 0x2A}, {0x36, 0x6F, 0x11, 0x4E, 0x0C, 0x31, 0x00, 0x00}, "5-2 Clifftop Critters B2"},
        {0x4C, 0x06, {0x6C, 0x68}, {0x54, 0x2B}, {0x18, 0x67, 0x77}, {0xF8, 0x7F, 0x70, 0x42, 0xC9, 0x00, 0x00, 0x00}, "5-3 Rickety Rapids"},
        {0x10, 0x06, {0x6F, 0x25}, {0x5C, 0x95}, {0x18, 0x6E, 0xB5}, {0xF8, 0x7F, 0x70, 0x42, 0xC9, 0x00, 0x00, 0x00}, "5-3 Rickety Rapids B1"},
        {0x0C, 0x06, {0x6F, 0x94}, {0x5C, 0x95}, {0x18, 0x6F, 0x32}, {0xF8, 0x7F, 0x70, 0x42, 0xC9, 0x00, 0x00, 0x00}, "5-3 Rickety Rapids B2"},
        {0x47, 0x09, {0x77, 0xE9}, {0x57, 0xD0}, {0x1A, 0x71, 0x84}, {0xBA, 0x7F, 0x2F, 0x4E, 0xA3, 0x1C, 0x00, 0x00}, "5-4 Bazuka Bombard"},
        {0x0D, 0x09, {0x79, 0xD8}, {0x5D, 0xA9}, {0x1A, 0x79, 0x45}, {0xBA, 0x7F, 0x2F, 0x4E, 0xA3, 0x1C, 0x00, 0x00}, "5-4 Bazuka Bombard B1"},
        {0x1A, 0x09, {0x7A, 0xC5}, {0x5D, 0xA9}, {0x1A, 0x79, 0xF0}, {0xBA, 0x7F, 0x2F, 0x4E, 0xA3, 0x1C, 0x00, 0x00}, "5-4 Bazuka Bombard B2"},
        {0x32, 0x0A, {0x7D, 0xBE}, {0x59, 0x0E}, {0x10, 0x79, 0xBA}, {0x1F, 0x7F, 0x17, 0x5A, 0x0E, 0x35, 0x00, 0x00}, "5-5 Ugly Ducting"},
        {0x10, 0x0A, {0x7A, 0xE0}, {0x5E, 0x06}, {0x17, 0x7A, 0x44}, {0x1F, 0x7F, 0x17, 0x5A, 0x0E, 0x35, 0x00, 0x00}, "5-5 Ugly Ducting B1"},
        {0x10, 0x0A, {0x7B, 0x54}, {0x5E, 0x06}, {0x17, 0x7A, 0xF0}, {0x1F, 0x7F, 0x17, 0x5A, 0x0E, 0x35, 0x00, 0x00}, "5-5 Ugly Ducting B2"},
        {0x63, 0x0B, {0x7E, 0x55}, {0x55, 0xA8}, {0x18, 0x78, 0x65}, {0xF7, 0x43, 0x91, 0x22, 0x0C, 0x01, 0x00, 0x00}, "5-6 Stalagmite Frights"},
        {0x1E, 0x0B, {0x74, 0x56}, {0x5C, 0xEF}, {0x18, 0x73, 0xA7}, {0xF7, 0x43, 0x91, 0x22, 0x0C, 0x01, 0x00, 0x00}, "5-6 Stalagmite Frights B1"},
        {0x16, 0x0B, {0x75, 0x4A}, {0x5C, 0xEF}, {0x18, 0x74, 0x5F}, {0xF7, 0x43, 0x91, 0x22, 0x0C, 0x01, 0x00, 0x00}, "5-6 Stalagmite Frights B2"},
        {0x0B, 0x0A, {0x7E, 0x0B}, {0x59, 0x0E}, {0x1A, 0x7D, 0xD1}, {0xFF, 0x3A, 0xB8, 0x11, 0xF0, 0x08, 0x00, 0x00}, "5-B K.Rool Duel"},
    
        {0xC4, 0x0A, {0x7F, 0x11}, {0x59, 0x0E}, {0x17, 0x7C, 0x0D}, {0x16, 0x7F, 0x4C, 0x5A, 0x81, 0x35, 0x00, 0x00}, "6-1 Whiplash Dash"},
        {0x16, 0x0A, {0x7B, 0x89}, {0x5E, 0x06}, {0x17, 0x7B, 0x5D}, {0x16, 0x7F, 0x4C, 0x5A, 0x81, 0x35, 0x00, 0x00}, "6-1 Whiplash Dash B1"},
        {0x1E, 0x0A, {0x7C, 0x01}, {0x5E, 0x06}, {0x17, 0x7B, 0x92}, {0x16, 0x7F, 0x4C, 0x5A, 0x81, 0x35, 0x00, 0x00}, "6-1 Whiplash Dash B2"},
        {0x54, 0x09, {0x71, 0x12}, {0x57, 0xD0}, {0x1A, 0x6B, 0x69}, {0x7F, 0x63, 0xF5, 0x31, 0x8A, 0x00, 0x00, 0x00}, "6-2 Kuchuka Karnage"},
        {0x20, 0x09, {0x7B, 0x64}, {0x5D, 0xA9}, {0x1A, 0x7A, 0xD8}, {0x7F, 0x63, 0xF5, 0x31, 0x8A, 0x00, 0x00, 0x00}, "6-2 Kuchuka Karnage B1"},
        {0x0E, 0x09, {0x7C, 0x2D}, {0x5D, 0xA9}, {0x1A, 0x7B, 0x71}, {0x7F, 0x63, 0xF5, 0x31, 0x8A, 0x00, 0x00, 0x00}, "6-2 Kuchuka Karnage B2"},
        {0x3B, 0x0B, {0x45, 0x21}, {0x55, 0xA8}, {0x1A, 0x40, 0x03}, {0xFC, 0x56, 0x94, 0x45, 0x4C, 0x38, 0x00, 0x00}, "6-3 Haunted Hollows"},
        {0x1D, 0x0B, {0x75, 0xF4}, {0x5C, 0xEF}, {0x18, 0x75, 0x5C}, {0xFC, 0x56, 0x94, 0x45, 0x4C, 0x38, 0x00, 0x00}, "6-3 Haunted Hollows B1"},
        {0x2D, 0x0B, {0x77, 0x0E}, {0x5C, 0xEF}, {0x18, 0x75, 0xFF}, {0xFC, 0x56, 0x94, 0x45, 0x4C, 0x38, 0x00, 0x00}, "6-3 Haunted Hollows B2"},
        {0xDF, 0x08, {0x76, 0x64}, {0x56, 0xCB}, {0x17, 0x72, 0xA3}, {0xF7, 0x02, 0xF1, 0x01, 0xEC, 0x00, 0x00, 0x00}, "6-4 Rainforest Rumble"},
        {0x14, 0x08, {0x7A, 0x36}, {0x5D, 0x55}, {0x17, 0x79, 0x8C}, {0xF7, 0x02, 0xF1, 0x01, 0xEC, 0x00, 0x00, 0x00}, "6-4 Rainforest Rumble B1"},
        {0x17, 0x08, {0x79, 0x7C}, {0x5D, 0x55}, {0x17, 0x78, 0xE1}, {0xF7, 0x02, 0xF1, 0x01, 0xEC, 0x00, 0x00, 0x00}, "6-4 Rainforest Rumble B2"},
        {0x3B, 0x09, {0x7A, 0x66}, {0x57, 0xD0}, {0x16, 0x73, 0x2A}, {0x13, 0x6B, 0xF1, 0x35, 0xCD, 0x00, 0x00, 0x00}, "6-5 Barrel Boulevard"},
        {0x15, 0x09, {0x7C, 0xB7}, {0x5D, 0xA9}, {0x1A, 0x7C, 0x3C}, {0x13, 0x6B, 0xF1, 0x35, 0xCD, 0x00, 0x00, 0x00}, "6-5 Barrel Boulevard B1"},
        {0x15, 0x09, {0x7D, 0x47}, {0x5D, 0xA9}, {0x1A, 0x7C, 0xC6}, {0x13, 0x6B, 0xF1, 0x35, 0xCD, 0x00, 0x00, 0x00}, "6-5 Barrel Boulevard B2"},
        {0x45, 0x0B, {0x4C, 0x9E}, {0x55, 0xA8}, {0x1A, 0x45, 0xAC}, {0x1F, 0x1B, 0xF6, 0x0D, 0xCD, 0x00, 0x00, 0x00}, "6-6 Ghoulish Grotto"},
        {0x0F, 0x0B, {0x77, 0xC3}, {0x5C, 0xEF}, {0x18, 0x77, 0x25}, {0x1F, 0x1B, 0xF6, 0x0D, 0xCD, 0x00, 0x00, 0x00}, "6-6 Ghoulish Grotto B1"},
        {0x22, 0x0B, {0x78, 0x5D}, {0x5C, 0xEF}, {0x18, 0x77, 0xE7}, {0x1F, 0x1B, 0xF6, 0x0D, 0xCD, 0x00, 0x00, 0x00}, "6-6 Ghoulish Grotto B2"},
        {0x0B, 0x0B, {0x7E, 0x5E}, {0x55, 0xA8}, {0x1A, 0x7E, 0x0E}, {0xFF, 0x3A, 0xB8, 0x11, 0xF0, 0x08, 0x00, 0x00}, "6-B K.Rool's Last Stand"},
    };
    
    int a, i, bank;
    uint8_t bw[] = {0xBD, 0x77, 0x94, 0x52, 0xAD, 0x35, 0x42, 0x08}; // 16, 88, 160, 232
    
    int size = sizeof(dkl) / sizeof(struct dkl3_levels);
    
    for (i = 0; i < size; i++) {
        
        a = dkl[i].arch;
        rawlen = 0;
        bp_len = 0;
        
        memset(raw_data, 0, 0x4000);
        if (!tileset) {
            dkl_raw(rom, raw_data, &rawlen, dkl[i].raw[0], dkl[i].raw[1], dkl[i].raw[2]);
            dkl2_raw_fix(rom, raw_data, rawlen, (dkl[i].raw[0]*0x4000)+((dkl[i].rf1[0]-0x40)*256)+dkl[i].rf1[1], (0x10 * 0x4000)+((dkl[i].rf2[0]-0x40)*256)+dkl[i].rf2[1]);
            t_width  = dkl[i].t_width;
            t_height = rawlen / dkl[i].t_width;
        }
        else {
            tile_generator(raw_data, &rawlen, arch[a].tiles, 0);
            t_width = 16;
            t_height = (rawlen / t_width);
            if (rawlen % t_width) t_height++;
        }
        
        dkl2_tiles(rom, bp_data, &bp_len, arch[a].bp_bank[0], ((arch[a].bp_bank[1]-0x40)*256)+arch[a].bp_bank[2], arch[a].bp_bank[3]);
        
        bank = ((arch[a].lay[1] * 0x4000) + (arch[a].lay[2] * 0x1000));
        
        dkl_layout(rom, raw_data, lay_data, arch[a].lay[0], bank, t_width, t_height);
        
        if (sgb == 5) {
            decode_palette(rgb, &bw[0], 4);
        }
        else {
            decode_palette(rgb, &dkl[i].pal[0], 4);
        }
        
        gbc_assemble(bitplane, bp_data, lay_data, col_data, rgb, t_width, t_height, 0);
        
        strcpy(name, dkl[i].name);
        if (tileset) strcat(name, " Tiles");
        strcat(name, ".png");
        arrange_gbc(bitplane, (t_width*32), (t_height*32), dir, name);
        
    }
    
    free(bp_data);
    free(lay_data);
    free(raw_data);
    free(col_data);
    free(pal_data);
    free(rgb);
    free(bitplane);
    

} // dkl3_levels();
